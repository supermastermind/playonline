<!DOCTYPE html>
<html lang="en" style='min-width:100%;min-height:100%;'>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Super Master Mind</title> <!-- (this title will be overwritten) -->
<meta name="robots" content="noindex"> <!-- (this page shall be preferably accessed from the main site page) -->

<!-- Remote console at http://console.re/supermastermind displaying console text (provided all calls to "console.log(xxx)" are replaced by "console.re.log(xxx)")
and console errors (provided the .js scripts to be debugged are copied/pasted directly into this HTML file between <script>...</script> tags,
otherwise error details, among which error line numbers, will be lost):
<script src="https://console.re/connector.js" data-channel="supermastermind" id="consolerescript"></script>
<script>console.re.log('remote log enabled!');</script> -->

<script>
var pageLoadStartTime = "NA";
var globalErrorStatus = false;

// Check browser compatibility
try {
pageLoadStartTime = new Date();
try {
eval('"use strict"; class foo {}; let test_let_inst = 1; var fction_with_optional_args = function(p = true) {return p}; fction_with_optional_args();');
} catch (err) {
// Note: Internet Explorer does not support classes and functions with optional arguments. And old versions of Safari (< 10) will fail on the "let" instruction (error tested on Safari 9.1).
var errorMsg = "Your browser cannot run this game. This game can be run with the last versions of Chrome, Firefox, Edge, Safari: update your browser if necessary.";
// alert(errorMsg);
throw new Error(errorMsg);
}
if (typeof(Worker) == "undefined") {
var workerErrorMsg = "Your browser cannot run this game because it does not support Web workers. This game can be run with the last versions of Chrome, Firefox, Edge, Safari: update your browser if necessary.";
// alert(workerErrorMsg);
throw new Error(workerErrorMsg);
}
var storageErrorMet = true;
try {
if (typeof(Storage) !== 'undefined') {
localStorage.test_storage_ok = "abc";
if (localStorage.test_storage_ok == "abc") {
storageErrorMet = false;
}
}
}
catch (exc) {
}
if (storageErrorMet) {
// Note: such an error occurs for Edge run locally
var storageErrorMsg = "Your browser cannot run this game because it cannot store local data. This game can be run with the last versions of Chrome, Firefox, Edge, Safari: update your browser if necessary.";
// alert(storageErrorMsg);
throw new Error(storageErrorMsg);
}
}
catch (exc) {
alert(exc);
window.stop(); // stop any further execution if error at this early stage. Note: window.stop() does not work in Internet explorer.
globalErrorStatus = true;
}
</script>

<style>
/* *** Main styles *** */
body {
font-family: 'Verdana';
margin: 0%;
padding: 0%;
color: #777777;
font-size: calc(7px + .34vw);
background: black;
min-width: 100%;
min-height: 100%;
overflow-x: hidden; /* Hide horizontal scrollbar */
overflow-y: hidden; /* Hide vertical scrollbar */
}
#my_canvas {
margin: 0;
padding: 0;
background: transparent;
border: none;
border-radius: 1.5%;
position: fixed;
}
/* *** Classes for button styling using CSS *** */
.button {
font-family: Verdana;
background-color: white;
border: 2px solid black;
border-radius: 20%;
color: black;
margin: 0 0.1vw 0 0.1vw; /* top right bottom left */
padding: 0.5vh 2.0vw 0.5vh 2.0vw; /* top right bottom left */
text-align: center;
vertical-align: middle;
text-decoration: none;
font-weight: bold;
cursor: pointer;
-webkit-backface-visibility: visible;
}
.button:hover { /* (will be overridden dynamically) */
background-color: orange;
color: white;
}
.disabled {
opacity: 0.3;
cursor: not-allowed;
}

/* Safari 4.0 - 8.0 */
@-webkit-keyframes glowing_orange {
0%   {background-color: white;}
20%  {background-color: white;}
33%  {background-color: orange;}
47%  {background-color: white;}
60%  {background-color: orange;}
73%  {background-color: white;}
87%  {background-color: orange;}
100% {background-color: white;}
}
/* Standard syntax */
@keyframes glowing_orange {
0%   {background-color: white;}
20%  {background-color: white;}
33%  {background-color: orange;}
47%  {background-color: white;}
60%  {background-color: orange;}
73%  {background-color: white;}
87%  {background-color: orange;}
100% {background-color: white;}
}

/* Safari 4.0 - 8.0 */
@-webkit-keyframes glowing_purple {
0%   {background-color: white;}
20%  {background-color: white;}
33%  {background-color: purple;}
47%  {background-color: white;}
60%  {background-color: purple;}
73%  {background-color: white;}
87%  {background-color: purple;}
100% {background-color: white;}
}
/* Standard syntax */
@keyframes glowing_purple {
0%   {background-color: white;}
20%  {background-color: white;}
33%  {background-color: purple;}
47%  {background-color: white;}
60%  {background-color: purple;}
73%  {background-color: white;}
87%  {background-color: purple;}
100% {background-color: white;}
}

.blinking_orange {
-webkit-animation-name: glowing_orange; /* Safari 4.0 - 8.0 */
-webkit-animation-duration: 3.75s; /* Safari 4.0 - 8.0 */
animation-name: glowing_orange;
animation-duration: 3.75s;
-webkit-backface-visibility: hidden;
}
.fast_blinking_orange {
-webkit-animation-name: glowing_orange; /* Safari 4.0 - 8.0 */
-webkit-animation-duration: 2.75s; /* Safari 4.0 - 8.0 */
animation-name: glowing_orange;
animation-duration: 2.75s;
-webkit-backface-visibility: hidden;
}

.blinking_purple {
-webkit-animation-name: glowing_purple; /* Safari 4.0 - 8.0 */
-webkit-animation-duration: 3.75s; /* Safari 4.0 - 8.0 */
animation-name: glowing_purple;
animation-duration: 3.75s;
-webkit-backface-visibility: hidden;
}
.fast_blinking_purple {
-webkit-animation-name: glowing_purple; /* Safari 4.0 - 8.0 */
-webkit-animation-duration: 2.75s; /* Safari 4.0 - 8.0 */
animation-name: glowing_purple;
animation-duration: 2.75s;
-webkit-backface-visibility: hidden;
}

@-webkit-keyframes kdo_anim {
0% {opacity: 0;}
100% {width: 16%; opacity: 0.9;}
}

@keyframes kdo_anim {
0% {opacity: 0;}
100% {width: 16%; opacity: 0.9;}
}

.kdo
{
-webkit-animation: kdo_anim 3.33s;
animation: kdo_anim 3.33s;
}

/* Hide browser's default radio button */
input[type="radio"] {
appearance: none;
-webkit-appearance: none;
-moz-appearance: none;
width: 0;
height: 0;
margin: 0;
padding: 0;
}

.radio {
font-family: Verdana;
color: black;
white-space: nowrap; /* no line breaks */
margin: 0;
padding: 0 0.1vw 0 0.1vw; /* top right bottom left */
text-align: left;
text-decoration: none;
font-weight: bold;
box-shadow: none;
vertical-align: middle;
/* text not selectable */
-webkit-touch-callout: none;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}

/* Style radio when radio button is checked */
input[type="radio"]:checked + .radio {  /* (will be partly overridden dynamically) */
color: orange;
border-color: orange;
border-radius: 25%;
margin: 0;
padding: 0 1.0vw 0 1.0vw; /* top right bottom left */
}

.not_selectable {
/* text not selectable */
-webkit-touch-callout: none;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}

.game_loading /* (used during page loading) */
{ position: fixed;
height: 100%;
width: 100%;
top:0;
left: 0;
background: rgba(0, 0, 0, 0.6);
z-index:11111;
font-size: 2.0vh;
text-align: center;
padding-top: 25.0vh;
color: #fff;
/* text not selectable */
-webkit-touch-callout: none;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}

.page_transition /* (used during page transition) */
{ position: fixed;
height: 100%;
width: 100%;
top:0;
left: 0;
background: rgba(0, 0, 0, 0.6);
z-index:11111;
font-size: 2.0vh;
text-align: center;
padding-top: 25.0vh;
color: #fff;
/* text not selectable */
-webkit-touch-callout: none;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}

.game_aborted /* (used at game abortion) */
{ position: fixed;
height: 100%;
width: 100%;
top:0;
left: 0;
background: rgba(0, 0, 0, 0.4);
z-index:11111;
font-size: 2.0vh;
text-align: center;
padding-top: 25.0vh;
color: #fff;
/* text not selectable */
-webkit-touch-callout: none;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
</style>

<script src='lib/jquery-3.7.1.min.js'></script>
<script src="lib/pako_inflate-2.1.0.min.js"></script>
<script src='lib/tingle-master/dist/tingle.min.js'></script>

<script>
// See page https://developer.mozilla.org/fr/docs/Web/HTTP/Browser_detection_using_the_user_agent
var lastGlobalProgress = 0;
var classicalUserAgentStr = "";
var userAgentToHandle = navigator.userAgent;
var firefoxModeIdx = userAgentToHandle.toUpperCase().search("FIREFOX/");
var firefoxMode = ((firefoxModeIdx != -1) && (userAgentToHandle.toUpperCase().search("SEAMONKEY/") == -1));
if (firefoxMode) {
classicalUserAgentStr = userAgentToHandle.substring(firefoxModeIdx);
}
var edgeModeIdx = userAgentToHandle.toUpperCase().search("EDG/");
if (edgeModeIdx == -1) {
edgeModeIdx = userAgentToHandle.toUpperCase().search("EDGE/");
}
var edgeMode = ((!firefoxMode) && (edgeModeIdx != -1));
if (edgeMode) {
classicalUserAgentStr = userAgentToHandle.substring(edgeModeIdx);
}
var operaModeIdx = userAgentToHandle.toUpperCase().search("OPR/");
if (operaModeIdx == -1) {
operaModeIdx = userAgentToHandle.toUpperCase().search("OPERA/");
}
var operaMode = ((!firefoxMode) && (!edgeMode) && (operaModeIdx != -1));
if (operaMode) {
classicalUserAgentStr = userAgentToHandle.substring(operaModeIdx);
}
var chromeModeIdx = userAgentToHandle.toUpperCase().search("CHROME/");
if (chromeModeIdx == -1) {
chromeModeIdx = userAgentToHandle.toUpperCase().search("CHROMIUM/");
}
var chromeMode = ((!firefoxMode) && (!edgeMode) && (!operaMode) && (chromeModeIdx != -1));
if (chromeMode) {
classicalUserAgentStr = userAgentToHandle.substring(chromeModeIdx);
var nextSpaceIdx = classicalUserAgentStr.indexOf(" ");
if (nextSpaceIdx != -1) {
classicalUserAgentStr = classicalUserAgentStr.substring(0, nextSpaceIdx);
}
}
var safariModeIdx = userAgentToHandle.toUpperCase().search("SAFARI/");
var safariMode = ((!firefoxMode) && (!edgeMode) && (!operaMode) && (!chromeMode) && (safariModeIdx != -1));
if (safariMode) {
classicalUserAgentStr = userAgentToHandle.substring(safariModeIdx);
}

var userAgentStr = "";
var androidAppliInfoStr = null;
var android_appli = false;
var versionNameStr = "?";
var versionCodeStr = "?";
var versionCodeInt = -1;
var scriptsFullyLoaded = false;
var mobileMode = false;
var androidMode = false;
var smm = (decodeURI(location.href).indexOf('https://supermastermind.github.io/playonline/game.html') != -1);
try {
androidAppliInfoStr = new URL(decodeURI(location.href)).searchParams.get("android_appli");
if (androidAppliInfoStr != null) { // check if ...?android_appli=xxx in the URL
userAgentStr = "sdk" + androidAppliInfoStr;
android_appli = true;
try {
versionNameStr = new URL(decodeURI(location.href)).searchParams.get("version_name");
if (versionNameStr == null) {
versionNameStr = "?";
}
versionCodeStr = new URL(decodeURI(location.href)).searchParams.get("version_code");
if (versionCodeStr == null) {
versionCodeStr = "?";
}
else {
try {
versionCodeInt = parseInt(versionCodeStr);
if (isNaN(versionCodeInt) || (versionCodeInt < 0) || (versionCodeStr.indexOf(".") != -1)) {
versionCodeInt = -1;
}
}
catch (exc) {
versionCodeInt = -1;
}
}
var playerIdStr = new URL(decodeURI(location.href)).searchParams.get("player_id"); // (kept for backward compatibility)
if (playerIdStr != null) {
if (!localStorage.playerid) {
localStorage.playerid = playerIdStr;
}
}
var playerIdStr2 = new URL(decodeURI(location.href)).searchParams.get("pi"); // (new version)
if (playerIdStr2 != null) {
if (!localStorage.playerid) {
localStorage.playerid = playerIdStr2;
}
}
} catch (err_versioning) {}
userAgentStr = userAgentStr + "/" + versionNameStr + "/" + versionCodeStr;
}
if (!android_appli) {
if (classicalUserAgentStr != "") {
userAgentStr = classicalUserAgentStr;
}
else {
userAgentStr = userAgentStr + navigator.userAgent.replaceAll("AppleWebKit","AppleWK").replaceAll("Mozilla","Moz").replaceAll("Windows", "Win").replaceAll("/","").replaceAll(" ","");
}
}
} catch (err) {
userAgentStr = "??? " + navigator.userAgent;
}
if (android_appli && ((versionCodeInt == -1) || (versionCodeInt < 6))) {
var versionCodeErrorMsg = "Android app version is " + ((versionCodeInt == - 1) ? "invalid" : "too old (" + versionCodeInt + ")") + ". Please install the last update of the android app.";
alert(versionCodeErrorMsg);
window.stop(); // stop any further execution if error at this early stage. Note: window.stop() does not work in Internet explorer.
globalErrorStatus = true;
}
var oldBrowserVersion = false;
if (chromeMode && (classicalUserAgentStr != "")) {
if (classicalUserAgentStr.indexOf("Chrome/79.") != -1) { // Observed for Tvmaster - to be generalized if useful / possibly with window.stop();
oldBrowserVersion = true;
alert("Your Chrome browser version is old, please update it to avoid errors");
}
}

if ( (/Mobi/i.test(navigator.userAgent)) || (/Android/i.test(navigator.userAgent)) // (mobile device check 1/3)
|| (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Windows Phone|Lumia|PlayBook|BB10|Tablet|Opera Mobi|Opera Mini/i.test(navigator.userAgent)) // (mobile device check 2/3)
|| android_appli ) { // (mobile device check 3/3)
mobileMode = true;
if (/Android/i.test(navigator.userAgent) || android_appli) {
androidMode = true;
}
}

function makeid() {
let text = "";
let possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
for (let i = 0; i < 6; i++) {
text += possible.charAt(Math.floor(Math.random() * possible.length));
}
return text;
}
if (!localStorage.playerid) {
let id = makeid() + "-" + formatDate(new Date()); // (versus "_ddMMyy" in android app)
localStorage.playerid = id;
}

function displayAdsIfNeeded() {
if (localStorage.gamesok && (Number(localStorage.gamesok) >= 12)) {
if (!android_appli) {
if (localStorage.lastAdsDisplayTime && ((new Date()).getTime() - localStorage.lastAdsDisplayTime <= 20*60*1000)) { // 20 minutes
return;
}
if (localStorage.lastAdsDisplayGamesOk && (localStorage.gamesok - localStorage.lastAdsDisplayGamesOk <= 2)) {
return;
}
if ( !localStorage.lastAdsDisplayTime || ((new Date()).getTime() - localStorage.lastAdsDisplayTime >= 8*3600*1000) // 8 hours
|| !localStorage.lastAdsDisplayGamesOk || (localStorage.gamesok - localStorage.lastAdsDisplayGamesOk >= 25) ) {
localStorage.lastAdsDisplayTime = (new Date()).getTime(); // (duplicated code in index.html)
localStorage.lastAdsDisplayGamesOk = localStorage.gamesok; // (duplicated code in index.html)
// Load page with ads
// [DISABLE ADS] // window.location.href = 'index.html';
}
}
// else: for android app, ads shall be handled directly in the app
}
}
if (!globalErrorStatus) {
displayAdsIfNeeded();
}

var unknownIPAddressPrefix = '0.0.0'; // (Note: checked by GS SCRIPT)
var generalTableWidthStr = "44%";
var rulesTableWidthStr = "44%";
var scoresTableWidthStr = "100%";
var scoresFontSizeStr = "1.6vw";
var abbreviateScores = true;

var nbGamesPlayedAndWon = 0;
var nbGamesPlayed = 0;
var nbCodesPlayed = 0;
var nbColorSelections = 0;
var gameRulesDisplayed = false;
var debug_game_state = -1;
var debug_smm_state = -1;
var debug_on_resize_or_unload = 0;
var github_unicorn_error = false;
var github_html_error = false;
var github_load_error = false;
var gameInv = 0;
var precalculatedFileFetched = "init";
var gamesolver_load_state = -1;
var gamesolver_load_start_time = -1;
var smm_load_state = -1;
var currentGameNbColumns = -1;

var modernDisplay = false;
var legacyDisplayVariant = 0;

var HTML_geoloc_attempts = 0;
var HTML_geoloc_successes = 0;
var HTML_geoloc_errors = 0;
var last_valid_handle_stats_final_retry_str = "";

var gamesolver_blob = null;
var gamesolver_blob_error = "no_error";

// Temporary functions
var newGameButtonClick = function(nbColumns_p) {
console.log("newGameButtonClick(" + nbColumns_p + ") function not defined yet");
}
var gameOnGoing = function() {
console.log("gameOnGoing function not defined yet");
return true;
}
var resetCurrentCodeButtonClick = function() {
console.log("resetCurrentCodeButtonClick function not defined yet");
}
var playRandomCodeButtonClick = function() {
console.log("playRandomCodeButtonClick function not defined yet");
}
var revealSecretColorButtonClick = function() {
console.log("revealSecretColorButtonClick function not defined yet");
}
var showPossibleCodesButtonClick = function(invertMode = true, newPossibleCodeShown = -1, showModeForced = false, transientMode = false) {
console.log("showPossibleCodesButtonClick function not defined yet");
}
var settingsButtonClick = function() {
console.log("settingsButtonClick function not defined yet");
}

if (!localStorage.firstgamegeoloc) { // Keep existing value if it exists
localStorage.firstgamegeoloc = "fa";
}

var beforeunload_case = false;
$(window).on('beforeunload', function() { // Ask for a confirmation on window exit when a game is ongoing
try {
debug_on_resize_or_unload = 1;
if (last_valid_handle_stats_final_retry_str != "") {
// Asynchronous operations are not supported on beforeunload, thus the below beforeunload_case behaviour
eval("console.log('stats handled on unload');" + "beforeunload_case = true;" + last_valid_handle_stats_final_retry_str + "beforeunload_case = false;");
}
if (!android_appli) { // in case of android_appli, webview reload can be (a bit) delayed
if (gameOnGoing() && (currentAttemptNumber > 1)) { // (condition duplicated)
if (localStorage.firstname && (typeof nbColumns !== 'undefined') && (nbColumns >= 5)) { // (condition duplicated)
return "Do you really want to abort current game?"; // (message not displayed by all browsers, some browsers will display a generic message instead - code duplicated)
}
}
}
debug_on_resize_or_unload = 2;
}
catch (exc) {
console.log("error encountered at game abortion: " + exc);
return; // (no confirmation asked)
}
});

function formatDate(date) {
if (date == null) {
return "?";
}
let day = String(date.getDate());
if (day.length < 2) {
day = '0' + day;
}
let month = String(date.getMonth() + 1);
if (month.length < 2) {
month = '0' + month;
}
let year = String(date.getYear()-100);
return String(day + month + year);
}

function checkIfRecentPlayer() {
if (!localStorage.gamesok) {
return true;
}
if (Number(localStorage.gamesok) < 5) {
return true;
}
if (!localStorage.recent_player_reference_time) {
if (Number(localStorage.gamesok) > 10) {
// Backward compatibility for already existing players
localStorage.recent_player_reference_time = 0; // (very old time)
}
else {
// Set recent player reference time from "localStorage.gamesok == 5" event for new players
localStorage.recent_player_reference_time = (new Date()).getTime();
}
}
if (Number(localStorage.gamesok) < 15) {
return true;
}
else {
return ((new Date()).getTime() - localStorage.recent_player_reference_time <= 1.5*24*3600*1000); // 1.5 day ~ time to close PC's browser window
}
}

let nbLocationURLs = 2; // (shall be < precisionLocationId, IP-address based geolocation when id < precisionLocationId)
let alternateLocationId = ((nbLocationURLs+1 <= 5) ? 5 : nbLocationURLs+1); // (shall be < precisionLocationId, IP-address based geolocation when id < precisionLocationId)
let precisionLocationId = 10;
let locationURLs = new Array(nbLocationURLs);
let extraStr = ((smm && !localStorage.skip) ? "" : "x");
// Favor IPv4 addresses because IPv6 addresses change at each device reboot
// Note 06/2023: it is not clear if geolocation is better on average with legacy IPv4 addresses or with "still new" IPv6 addresses.
// - IPV4:
locationURLs[0] = 'https://api.ip' + extraStr + 'data.co/en?api-key=102' + extraStr + 'c5eac3a9c7c5dad17519b2029bb6bdf4a076b60dde282eecaf99f'; // (free key - seems to always return an IPv4 address, even if not documented, and even if this site supports both IPv4 and IPv6 address when in input)
// - IPv6 (most of the time):
locationURLs[1] = 'https://api.ip' + extraStr + 'infodb.com/v3/ip-city/?key=792' + extraStr + 'e8cda21ab40a7f5a349cddc79beb41ff95910c2ec0d05bfea593961e01c7a&format=json'; // (free key - returns most of the time an IPv6 address)
// - IPV4 (backup): site not used because table updates seem less freqeuent than api.ipdata.co and because successful even when invalid IP address: locationURLs[X] = 'https://ip' + extraStr + 'info.io/json/?token=ca8' + extraStr + '32119df7bb5'; // (free key - returns always an IPv4 address by default, https://v6.ipinfo.io/json URL would have to be used for IPv6 as described in this page https://ipinfo.io/faq/article/34-ipv4-vs-ipv6)
</script>

<link rel='stylesheet' type='text/css' href='lib/tingle-master/dist/tingle.min.css'>
</head>

<body onresize="eval('try{debug_on_resize_or_unload = 3;draw_graphic();debug_on_resize_or_unload = 4;}catch(e){}');">

<div id="game_loading_id" class="game_loading">
<img src='img/loading.gif' style='height:12%;'><br>Loading... <!-- (not rem unit as no viewport! / duplicated code) -->
</div>

<div id="page_transition_id" class="page_transition" style='display:none;'>
</div>

<div id="game_aborted_id" class="game_aborted" style='display:none;' onclick="gameAbortionEnd()">
<!-- (text will be overridden dynamically) -->
</div>

<!-- HTML controls and canvas -->

<table id='my_table' style='width:100%;height:100%;position:absolute;left:0;top:0;border:none;border-radius:0%;margin:0;padding:0;'>
<tr>
<td class='not_selectable' style='width:100%;height:1%;margin:0;padding:0;vertical-align:middle;text-align:center;border:none;white-space:nowrap;' id='buttons_td'>
<input id='newGameButton' class='button disabled' type='button' value='NEW' title='Start a new game' onclick='newGameButtonClick(0)' onfocus='this.blur()' disabled>
<form action='' style='display:inline;vertical-align:middle;'>
<label title='Very easy game'>
<input type="radio" name='nbColumnsSelection' id='nbColumnsSelection_3' value="3" onclick='newGameButtonClick(3)'><span id='columnsspan_3' class='radio disabled' name='radio_name'>3</span>
</label>
<label title='Master Mind'>
<input type="radio" name='nbColumnsSelection' id='nbColumnsSelection_4' value="4" onclick='newGameButtonClick(4)'><span id='columnsspan_4' class='radio disabled' name='radio_name'>4</span>
</label>
<label title='Super Master Mind'>
<input type="radio" name='nbColumnsSelection' id='nbColumnsSelection_5' value="5" onclick='newGameButtonClick(5)'><span id='columnsspan_5' class='radio disabled' name='radio_name'>5</span>
</label>
<label title='Mega Master Mind'>
<input type="radio" name='nbColumnsSelection' id='nbColumnsSelection_6' value="6" onclick='newGameButtonClick(6)'><span id='columnsspan_6' class='radio disabled' name='radio_name'>6</span>
</label>
<label title='Ultra Master Mind'>
<input type="radio" name='nbColumnsSelection' id='nbColumnsSelection_7' value="7" onclick='newGameButtonClick(7)'><span id='columnsspan_7' class='radio disabled' name='radio_name'>7</span>
</label>
</form>
<input id='resetCurrentCodeButton' class='button disabled' type='button' value='Reset' title='Reset current code' onclick='resetCurrentCodeButtonClick()' onfocus='this.blur()' disabled>
<input id='playRandomCodeButton' class='button disabled' type='button' value='Random' title='Play a random code' onclick='playRandomCodeButtonClick()' onfocus='this.blur()' disabled>
<input id='revealSecretColorButton' class='button disabled' type='button' value='Reveal' title='Reveal a color of the secret code' onclick='revealSecretColorButtonClick()' onfocus='this.blur()' disabled>
<input id='showPossibleCodesButton' class='button disabled' type='button' value='Codes' title='Show possible codes at each stage of the game (when game is over)' onclick='showPossibleCodesButtonClick()' onfocus='this.blur()' disabled>
<input id='settingsButton' class='button disabled' type='button' value='&#x2026;' title='Info & settings' onclick='settingsButtonClick()' onfocus='this.blur()' disabled>
</td>
</tr>
<tr>
<td style='width:100%;margin:0;padding:0;vertical-align:top;align:left;text-align:left;border:none;border-radius:1.5%;' id='my_canvas_cell'><canvas id='my_canvas' oncontextmenu='return false;'><font color=red>Error: HTML canvas are not supported!</font></canvas></td>
</tr>
</table>

<iframe style='display:none;' name='my_frame'>Your browser does not support iframes!</iframe> <!-- suppress style='display:none;' to see the form's response -->
<form  style='display:none;' id='my_form' target='my_frame' action='to_be_filled'>
playerid: <input id='form_playerid_id' name='playerid' type='text' value='-'><br>
firstname: <input id='form_firstname_id' name='firstname' type='text' value='-'><br>

nbcolumns: <input id='form_nbcolumns_id' name='nbcolumns' type='text' value='-'><br>
score: <input id='form_score_id' name='score' type='text' value='-'><br>
attempts: <input id='form_attempts_id' name='attempts' type='text' value='-'><br>
time: <input id='form_time_id' name='time' type='text' value='-'><br>
perfs: <input id='form_perfs_id' name='perfs' type='text' value='-'><br>
nbuknperfs: <input id='form_nbuknperfs_id' name='nbuknperfs' type='text' value='-'><br>
help: <input id='form_help_id' name='help' type='text' value='-'><br>

gamesok: <input id='form_gamesok_id' name='gamesok' type='text' value='-'><br>
deltagames: <input id='form_deltagames_id' name='deltagames' type='text' value='-'><br>
app: <input id='form_app_id' name='app' type='text' value='-'><br>

country: <input id='form_country_id' name='country' type='text' value='-'><br>
region: <input id='form_region_id' name='region' type='text' value='-'><br>
city: <input id='form_city_id' name='city' type='text' value='-'><br>
geoloc: <input id='form_geoloc_id' name='geoloc' type='text' value='-'><br>
ipaddress: <input id='form_ipaddress_id' name='ipaddress' type='text' value='-'><br>

href: <input id='form_href_id' name='href' type='text' value='-'><br>

bestglbscore: <input id='form_bestglbscore_id' name='bestglbscore' type='text' value='-'><br>
bestglbperf: <input id='form_bestglbperf_id' name='bestglbperf' type='text' value='-'><br>

debuginfo: <input id='form_debuginfo_id' name='debuginfo' type='text' value='-'><br>
gamesummary: <input id='form_gamesummary_id' name='gamesummary' type='text' value='-'><br>

list: <input id='form_list_id' name='list' type='text' value='-'><br>
</form>

<form style='display:none;' id='my_all_scripts_loaded_form' target='my_frame' action='https://ALL_SCRIPTS_LOADED'>
</form>

<p id='traces_id' style='color:#AAAAAA;'></p>

<!-- Display extra text and pictures -->

<p style='text-align:right'>
<script>
let welcome_str = "Welcome";
try {
if ((navigator.language == "fr") || (navigator.language.indexOf("fr-") == 0)) { // covers "fr", "fr-FR", "fr-BE", "fr-CA", "fr-CH", "fr-LU"
welcome_str = "Bienvenue";
}
}
catch (exc) {}
if (localStorage.firstname && localStorage.playerid) {
let kdo_str = "";
if ((localStorage.firstname == "Jeannot") && (localStorage.playerid.indexOf("9XG5") != -1)) {
kdo_str = "<br><img src='img/Kdo.png' align='left' class='kdo' style='width:7.7%;margin:0.5% 0 0 1.0%;border-radius:40%'>";
}
document.write("<font color=#DDDDDD><span id='welcome_id' style='float:left;'>&nbsp;&nbsp;" + welcome_str + " <b><font color=yellow>" + localStorage.firstname + "</font></b>!</span></font>" + "<span id='kdo_id'>" + kdo_str + "</span>");
setTimeout(function() {
$("#welcome_id").fadeOut().empty();
}, 60000);
setTimeout(function() {
$("#kdo_id").fadeOut().empty();
}, 60000);
}

var eoy_date = new Date();
var m = eoy_date.getMonth();
var d = eoy_date.getDate();
if (!android_appli && !mobileMode) {
if ( ((m == 11) && (d >= 15)) // after December 15th
|| ((m == 0) && (d <= 2)) ) { // before January 2nd
// (Display values will be updated below if necessary)
document.write("<img id='img_1' style='display:none;' src='img/End_of_year.png'>&nbsp;<br><img id='img_2' style='display:none;' src='img/End_of_year2.png'>&nbsp;");
}
}
</script>
</p>

<script>

let html_compatibility_game_version = "v30.02"; // !WARNING! -> value to be aligned with version in SuperMasterMind.js => search "v30" for all occurrences in this file and this script
let current_smm_compatibility_version = "not filled yet";
let modeAlreadySelected = false;
let lastKeyCheck = false;
document.body.onkeydown = function(e) {
if (modeAlreadySelected) {
return;
}
let keycheck1 = (String.fromCharCode(e.keyCode).toLowerCase() == '1');
let keycheck2 = ((String.fromCharCode(e.keyCode).toLowerCase() == 'l') && e.shiftKey);
if (keycheck1 && (!lastKeyCheck)) {
lastKeyCheck = true;
}
else if (keycheck2 && lastKeyCheck) {
try {
modeAlreadySelected = true;
handlePrompt();
}
catch (exc) {
alert(exc);
}
}
else {
lastKeyCheck = false;
}
};

// Global AJAX settings
$.ajaxSetup({
timeout: 90000, // 90 seconds by default
cache: false // no cache (see https://api.jquery.com/jQuery.ajax/)
});

var modal_mode = -1;
var store_time = (new Date()).getTime();
var minFirstNameLength = 3;
var maxFirstNameLength = 9;

function askLocationPermissionsIfNeeded() {
if (!android_appli) {
return;
}
if (localStorage.nb_location_permissions_requests && (Number(localStorage.nb_location_permissions_requests) >= 1)) {
var nb_days = ((localStorage.nb_location_permissions_requests == 1) ? 1 : 4);
if (Number(localStorage.nb_location_permissions_requests) >= 8) {
nb_days = 30; // player does not want to share position or "repetitive single permissions"
}
if (localStorage.ask_location_permissions_if_needed && ((new Date()).getTime() - localStorage.ask_location_permissions_if_needed < nb_days*24*3600*1000)) { // x days (permission message or warning message every x days)
return;
}
}
var ask_location_permissions_if_needed_str = "console.log('(ask location permissions if needed)');" // !WARNING! -> this console text will be read by the android app so shall not be modified
setTimeout(ask_location_permissions_if_needed_str, 1000);
localStorage.ask_location_permissions_if_needed = (new Date()).getTime();
if (!localStorage.nb_location_permissions_requests) {
localStorage.nb_location_permissions_requests = 0;
}
localStorage.nb_location_permissions_requests = Number(localStorage.nb_location_permissions_requests) + 1;
}

var modal = new tingle.modal({
footer: false,
stickyFooter: false,
closeMethods: ['overlay', 'button', 'escape'],
// closeMethods: ['button'],
closeLabel: "Close",
cssClass: ['custom-class-1', 'custom-class-2'],
onOpen: function() {
console.log('(modal onOpen)');
},
onClose: function() {
console.log('(modal onClose)');
},
beforeClose: function() {

console.log('(modal beforeClose)');
if (modal_mode == 2) {

setTimeout("showPossibleCodesButtonClick(false, -2, true);", 444);

modal_mode = -1;
return true; // close the modal
}

else if (modal_mode == 5) {
newGameButtonClick(5);
modal_mode = -1;
askLocationPermissionsIfNeeded();
return true; // close the modal
}

// else (other modal_mode values)
modal_mode = -1;
return true; // close the modal
// return false; // nothing happens

}
});

let loaded_sizes = new Array(3);
loaded_sizes[0] = 234000; // imported js scripts + game.html = 88000 (jquery) + 22000 (pako) + 7000 (tingle) + 117000 (game.html) = 234000
loaded_sizes[1] = 138000; // GameSolver.js (state: 1)
loaded_sizes[2] =  97000; // SuperMasterMind.js.gz (state: 2)
function getGlobalProgress(progress, state) {
if ((progress < 0) || (progress > 1)) { // error case
return 0;
}
let sum_loaded_sizes = loaded_sizes[0] + loaded_sizes[1] + loaded_sizes[2];

if (state == 0) {
let percent_min = 0;
let percent_max = 100 * loaded_sizes[0] / sum_loaded_sizes;
return Math.min(100, Math.round(percent_min + progress * (percent_max - percent_min)));
}
else if (state == 1) {
let percent_min = 100 * loaded_sizes[0] / sum_loaded_sizes;
let percent_max = 100 * (loaded_sizes[0]+loaded_sizes[1]) / sum_loaded_sizes;
return Math.min(100, 2*Math.round((percent_min + progress * (percent_max - percent_min))/2));
}
else if (state == 2) {
let percent_min = 100 * (loaded_sizes[0]+loaded_sizes[1]) / sum_loaded_sizes;
let percent_max = 100;
return Math.min(100, 2*Math.round((percent_min + progress * (percent_max - percent_min))/2));
}
else {
console.log("getGlobalProgress: invalid state: " + progress + ", " + state); // (errors are not handled yet)
}
}
var globalProgressForHTMLGame1 = getGlobalProgress(0.50 /* (rough value) */, 0);
console.log("current progress: " + Math.max(globalProgressForHTMLGame1, lastGlobalProgress) + "% (g)"); lastGlobalProgress = globalProgressForHTMLGame1; // !WARNING! -> this console text will be read by the android app so shall not be modified
if (globalProgressForHTMLGame1 > 0) {
$("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgressForHTMLGame1 + "%)"); // (not rem unit as no viewport! / duplicated code)
}

String.prototype.replaceAll = function(search, replacement) {
let target = this;
return target.replace(new RegExp(search, 'g'), replacement);
};
function replaceAllElementsInStruct(struct, search, replacement) {
for (let element in struct) {
if (typeof struct[element] === "string") {
struct[element] = struct[element].replaceAll(search, replacement);
}
}
};

function str_from_jqxhr(jqxhr) { // (jqxhr: XMLHTTPRequest)
try {
let str = "jqxhr={";
try {
/* Status:
200: "OK"
403: "Forbidden"
404: "Page not found"
... */
str = str + "status:" + jqxhr.status;
str = str + ",statusText:" + jqxhr.statusText;
/* readyState holds the status of the XMLHttpRequest:
0: request not initialized
1: server connection established
2: request received
3: processing request
4: request finished and response is ready */
str = str + ",readyState:" + jqxhr.readyState;
}
catch (exc) {
str = str + "?";
}
str = str + "}";
return str;
}
catch (exc) {
return "jqxhr=?";
}
}

var smm_action = "https://script.google.com/macros/s/AKf" + extraStr + "ycbx7dfFn4JQGWWcKEjHUqPk42AxlZBcnQ5AiFcuY3op6azRwNRCJfUFNuwSjBUN_GXsQ/exec";
var mm_mmm_umm_action = "https://script.google.com/macros/s/AKf" + extraStr + "ycbxuCShh1eJtEmwgRF6ZY47HrdVfPgoJ4lVK7OD_Pxj5tanlThWdwqnb--9m1aafYid3/exec";
var nbErrorsSubmitted = 0;
function submitForm(formStr = "", errorId = 0) {

if (globalErrorStatus) { // skip submitForm when a basic global error occurred
console.log("(submitForm skipped due to global error)");
return;
}
if (localStorage.skip) {
return;
}

let handle_stats_final_retry_str = "";
let handle_stats_final_retry_conditional_str = "";
let key = Math.floor(Math.random()*9999999999+1).toString(32);
let my_params = {};
if (formStr == "") { // Nominal case
var nbColumns_in_form = document.getElementById('form_nbcolumns_id').value;
var form_list_in_form = document.getElementById('form_list_id').value;

if (form_list_in_form == '-') {
switch (String(nbColumns_in_form)) {
case "5":
document.getElementById("my_form").action = smm_action;
break;
case "4":
case "6":
case "7":
document.getElementById("my_form").action = mm_mmm_umm_action;
break;
default:
throw new Error("submitForm error: " + nbColumns_in_form);
}
}
else {
if (form_list_in_form.indexOf('2') == -1) {
document.getElementById("my_form").action = smm_action;
}
else {
document.getElementById("my_form").action = mm_mmm_umm_action;
}
}

// console.log(JSON.stringify($("#my_form").serializeArray()));
let elements = document.getElementById("my_form").elements;
for (let i = 0, element; element = elements[i++];) {
my_params[element.name] = element.value;
}
if (abbreviateScores) {
my_params['compressrsp'] = abbreviateScores;
}
if (mobileMode) {
my_params['mobilemode'] = mobileMode;
}

if (form_list_in_form == '-') {
handle_stats_final_retry_str = "handle_stats_bis(" + nbColumns_in_form + ", 99, 99, 'N', '" + document.getElementById('form_playerid_id').value + "', '" + key + "', " + "'Y2');";
last_valid_handle_stats_final_retry_str = handle_stats_final_retry_str;
handle_stats_final_retry_conditional_str = "if(window.navigator.onLine){" + handle_stats_final_retry_str + "}else{console.log('stats form submission skipped (nw)');}";
setTimeout(handle_stats_final_retry_conditional_str, 60000);
setTimeout(handle_stats_final_retry_str, 120000);
}
}
else { // Specific error case
nbErrorsSubmitted++;
if (nbErrorsSubmitted > 4) {
return;
}
document.getElementById('form_nbcolumns_id').value = "N.A."; // (ensure failure at handling)
document.getElementById("my_form").action = (((currentGameNbColumns == -1) || (currentGameNbColumns == 5)) ? smm_action : mm_mmm_umm_action);
my_params['form_str'] = "(error id: " + errorId + ") " + formStr;
}
my_params['k'] = key;
my_params['v'] = html_compatibility_game_version;
my_params['retr'] = 'N';

// Avoid request blocking by Chrome for the following reason:
// "Resource requests whose URLs contained both removed whitespace (`\n`, `\r`, `\t`) characters and less-than characters (`<`) are blocked.
//  Please remove newlines and encode less-than characters from places like element attribute values in order to load these resources.
//  See https://www.chromestatus.com/feature/5735596811091968 for more details."
replaceAllElementsInStruct(my_params, "\n", " "); // (duplicated code)
replaceAllElementsInStruct(my_params, "\r", ""); // (duplicated code)
replaceAllElementsInStruct(my_params, "\t", " "); // (duplicated code)
// replaceAllElementsInStruct(my_params, "<", "_");
// replaceAllElementsInStruct(my_params, ">", "_"); // (symmetrical replace applied)

// Submit form
let my_form_url = document.getElementById("my_form").action;
console.log("(submit form" + ((formStr == "") ? "" : " for a specific case") + ")");
$.ajax({
crossDomain: true,
url: my_form_url,
data: my_params,
method: "GET",
dataType: "jsonp",
timeout: 30000 // 30 seconds
})
.fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
if (formStr == "") { // Nominal case
try {
if (jqxhr.status != 200) { // Note: covers the 404 status which corresponds to the error "Loading failed for the <script> with source https://..."
console.log(("form submission failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());

my_params['retr'] = 'Y';
$.ajax({
crossDomain: true,
url: my_form_url,
data: my_params,
method: "GET",
dataType: "jsonp",
timeout: 30000 // 30 seconds
})
.fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
try {
if (jqxhr.status != 200) { // Note: covers the 404 status which corresponds to the error "Loading failed for the <script> with source https://..."
console.log(("form submission retry failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
if (handle_stats_final_retry_conditional_str != "") {
setTimeout(handle_stats_final_retry_conditional_str, 20000);
}
} // else: systematic parse error (with 200 status) is ignored
}
catch (exc) {
console.log(("form submission retry failure (abnormal case): " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
}
});
} // else: systematic parse error (with 200 status) is ignored
}
catch (exc) {
console.log(("form submission failure (abnormal case): " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
}
}
});

// document.getElementById('my_form').submit();
// $("#my_form").submit();
}

function submitError(errorStr) { // CALLED BY ANDROID APP
try {
submitForm("error submitted by android app: " + String(errorStr), 10);
}
catch (exc) {
submitForm("submitError() handling error", 20);
}
}

function getMemoryUsage() {
let res = "memory usage:";
try {
res = res + String(performance.memory.usedJSHeapSize) /* used */ + "|" + String(performance.memory.totalJSHeapSize) /* allocated, >= used */ + "|" + String (performance.memory.jsHeapSizeLimit) /* maximum heap size */;
}
catch (exc) { // always fails in Firefox
res = res + "unknown";
}
return res;
}

// Temporary error handling (from this point in this file to simplify / will be overwritten later)
function game_onerror(message, url, lineNo, columnNo, error) {
let err_str = "tbc";
try {
err_str = ('error:' + message
+ '|url:' + url
+ '|line number:' + lineNo
+ '|column number:' + columnNo
+ '|error object:' + error).trim();
// Skip useless errors:
// Uncaught TypeError: Cannot read properties of undefined (reading 'query') / chrome-extension://fcneeeckalcgcklbloocjmhapagkkbfa/controls.js in ...
if (url.indexOf("fcneeeckalcgcklbloocjmhapagkkbfa") != -1) { // video extension
return;
}
// Uncaught TypeError: Cannot read properties of undefined (reading 'sendMessage') / chrome-extension://ofdopmlmgifpfkijadehmhjccbefaeec/assets/comms/commsMngr.js in ...
if (url.indexOf("ofdopmlmgifpfkijadehmhjccbefaeec") != -1) { // extension
return;
}
// Injected script
if ((url.indexOf("hosteagle") != -1) || (url.indexOf("injectedScript") != -1))  {
return;
}
}
catch (error) {}

try {
// Error observed after game start (timesinceworkercreation ~ 23s) on "Mozilla/5.0 (iPhone; CPU iPhone OS 12_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148" useragent,
// but not preventing (at least always?) game play (+ scores stored):
// - message = TypeError: null is not an object (evaluating 'reader.content')
// - url = https://supermastermind.github.io/playonline/game.html
if ( (message.indexOf("TypeError: null is not an object (evaluating 'reader.content')") != -1)
&& (url.indexOf("game.html") != -1) ) {
return;
}
// Error "ResizeObserver loop limit exceeded": minor error (which would be caused by some browser extensions) that can be skipped
if (message.indexOf("ResizeObserver loop limit exceeded") != -1) {
return;
}
// Error: window error: TypeError: undefined is not an object (evaluating 'document.getElementsByTagName('video')[0].webkitExitFullScreen')
if (message.indexOf("webkitExitFullScreen") != -1) {
return;
}
// sporadic Safari [extension?] error
if (message.indexOf("undefined is not an object (evaluating 'a.L')") != -1) {
return;
}
}
catch (error) {}

var extra_debug_info = ""; // (duplicated code)
if (localStorage.firstname) {
extra_debug_info = extra_debug_info + localStorage.firstname;
}
if (localStorage.playerid) {
extra_debug_info = extra_debug_info + " " + localStorage.playerid;
}
extra_debug_info = extra_debug_info + (localStorage.gamesok ? " gamesok=" + localStorage.gamesok : "");
try {
extra_debug_info = extra_debug_info + " gameOnGoing=" + gameOnGoing() + "|currentAttemptNumber=" + currentAttemptNumber + "|gameWon=" + gameWon;
}
catch (exc) {}
try {
extra_debug_info = extra_debug_info + " gamesolver_blob:" + gamesolver_blob_error + "|" + ((gamesolver_blob != null) ? gamesolver_blob.size : "null gamesolver_blob");
}
catch (exc) {}
try {
extra_debug_info = extra_debug_info + " " + getMemoryUsage() + (oldBrowserVersion ? " oldbrowser" : "");
}
catch (exc) {}
extra_debug_info = extra_debug_info.trim();
if (extra_debug_info == "") {
extra_debug_info = "-";
}
submitForm("***** GAME ERROR ***** (game: " + html_compatibility_game_version + ", smm: " + current_smm_compatibility_version + ", alignment for v30.02: " + (localStorage.reloadForCompatibility_v3002 ? localStorage.reloadForCompatibility_v3002 : "not done") + "): "
+ (github_unicorn_error ? "github unicorn error - " : "") + (github_html_error ? "github html error - " : "") + (github_load_error ? "github load error - " : "")
+ err_str + " in " + userAgentStr + (android_appli ? "|" + classicalUserAgentStr : "") + " (start time:" + pageLoadStartTime + "/error time:" + new Date() + ")"
+ " / debug: " + nbGamesPlayed + "|" + nbGamesPlayedAndWon
+ "|game:" + debug_game_state
+ "|smm:" + smm_load_state + "," + debug_smm_state
+ "|resizeorunload:" + debug_on_resize_or_unload
+ "|gamesolver:" + gamesolver_load_state + "|" + ((gamesolver_load_start_time != -1) ? ((new Date()).getTime() - gamesolver_load_start_time)/1000 + "s" : "-")
+ " for " + extra_debug_info, 30);
}
window.onerror = game_onerror; // Note: this error capture can be redundant with the other error captures like gameSolver.onerror (same error submitted several times)
</script>
<script>
"use strict"; // new script section with ""use strict";", as window.onerror was just set

function game_event_onerrors(evt, errormsg, cause) {
var evt_str = "-";
try {
evt_str = JSON.stringify(evt).substring(0, 101).trim();
}
catch (exc) {}
var evt_promise_str = "-";
try {
evt_promise_str = JSON.stringify(evt.promise).substring(0, 101).trim();
}
catch (exc) {}
var extra_debug_info = ""; // (duplicated code)
if (localStorage.firstname) {
extra_debug_info = extra_debug_info + localStorage.firstname;
}
if (localStorage.playerid) {
extra_debug_info = extra_debug_info + " " + localStorage.playerid;
}
extra_debug_info = extra_debug_info + (localStorage.gamesok ? " gamesok=" + localStorage.gamesok : "");
try {
extra_debug_info = extra_debug_info + " gameOnGoing=" + gameOnGoing() + "|currentAttemptNumber=" + currentAttemptNumber + "|gameWon=" + gameWon;
}
catch (exc) {}
extra_debug_info = extra_debug_info.trim();
if (extra_debug_info == "") {
extra_debug_info = "-";
}
submitForm("***** " + errormsg + " ***** (" + html_compatibility_game_version + "): event: " + evt + "|" + evt_str + " / reason: " + evt.reason + " / promise: " + evt.promise + "|" + evt_promise_str + " | cause: " + cause + " / debug: " + nbGamesPlayed + "|" + nbGamesPlayedAndWon + "|" + debug_game_state + "|" + debug_on_resize_or_unload + " for " + extra_debug_info + " in " + userAgentStr, 40);
}
window.onmessageerror = function(evt) {
game_event_onerrors(evt, "GAME MESSAGE ERROR", "onmessageerror");
};
window.onunhandledrejection = function(evt) {
game_event_onerrors(evt, "GAME UNHANDLEDREJECTION ERROR", "onunhandledrejection");
};
window.onrejectionhandled = function(evt) {
game_event_onerrors(evt, "GAME REJECTIONHANDLED ERROR", "onrejectionhandled");
};

var documentDOMContentLoadedEventReceived = "no";
document.addEventListener("DOMContentLoaded", function() {
try {
documentDOMContentLoadedEventReceived = "yes";
}
catch (exc) {}
});
var windowOnLoadEventReceived = "no";
window.onload = function() {
try {
windowOnLoadEventReceived = "yes";
}
catch (exc) {}
}

function capitalizeFirstLetter(str) {
return str.charAt(0).toUpperCase() + str.slice(1);
}

function capitalizeFirstLetters(str) {
if (str.length == 0) {
return "";
}
else if (str.length == 1) {
return str.charAt(0).toUpperCase();
}
else {
let res = str.toLowerCase();
res = res.charAt(0).toUpperCase() + res.slice(1);

let res2 = "";
let index = res.indexOf('-');
while ((index != -1) && (index+1 < res.length)) {
res2 = res2 + res.substring(0, index+1) + res.charAt(index+1).toUpperCase();
if (index+2 < res.length) {
res = res.slice(index+2);
index = res.indexOf('-');
}
else {
res = "";
index = -1;
}
}
res2 = res2 + res;
res = res2;
res2 = "";
index = res.indexOf(' ');
while ((index != -1) && (index+1 < res.length)) {
res2 = res2 + res.substring(0, index+1) + res.charAt(index+1).toUpperCase();
if (index+2 < res.length) {
res = res.slice(index+2);
index = res.indexOf(' ');
}
else {
res = "";
index = -1;
}
}
res2 = res2 + res;

res = res2;
res2 = "";
index = res.indexOf("'");
while ((index != -1) && (index+1 < res.length)) {
res2 = res2 + res.substring(0, index+1) + res.charAt(index+1).toUpperCase();
if (index+2 < res.length) {
res = res.slice(index+2);
index = res.indexOf("'");
}
else {
res = "";
index = -1;
}
}
res2 = res2 + res;

res2 = res2.replace(" D'"," d'");
res2 = res2.replace(" Sur "," sur ");

return res2;
}
}

function guessUserId() {
let guessedIdStr = "";
if (firefoxMode) {
guessedIdStr = "F";
}
else if (edgeMode) {
guessedIdStr = "E";
}
else if (chromeMode) {
guessedIdStr = "C";
}
else if (safariMode) {
guessedIdStr = "S";
}
else if (operaMode) {
guessedIdStr = "O";
}
else {
guessedIdStr = "X";
}
return "GID:" + guessedIdStr + ((screen.width * screen.height * screen.colorDepth) % 997);
}

function getLocation() {
switch(location.protocol) {
case 'http:':
return 'P1';
case 'https:':
return 'P1b';
case 'file:':
return 'P2';
default:
// (other protocols)
return 'P3';
}
}

function nbVowels(str)
{
var vowel_list = 'aeiouyAEIOUY'; // (accentuated vowels are not considered here)
var vowel_count = 0;
for (var i = 0 ; i < str.length ; i++) {
if (vowel_list.indexOf(str[i]) !== -1) {
vowel_count++;
}
}
return vowel_count;
}

function getCountryNameFromBrowserLanguage(defaultCountryName) {
let browserlanguage = navigator.language;
let dashIdx = browserlanguage.indexOf("-");
if (dashIdx != -1) {
browserlanguage = browserlanguage.substring(dashIdx+1);
}
browserlanguage = browserlanguage.toUpperCase().trim();
if (browserlanguage.length >= 2) { // all country name abbreviations are 2 characters long
return browserlanguage;
}
else {
return defaultCountryName;
}
}

function isCorrect(str) {
if ( (str.length < minFirstNameLength)
|| (str.length > maxFirstNameLength)
|| (str.toLowerCase().indexOf('sherl') != -1) // (Sherlock)
|| (str.toLowerCase().indexOf('holm') != -1) // (Sherlock)
|| (str.toLowerCase().indexOf('watson') != -1) // (Sherlock)
|| (str.toLowerCase().indexOf('aaa') != -1)
|| (str.toLowerCase().indexOf('bbb') != -1)
|| (str.toLowerCase().indexOf('ccc') != -1)
|| (str.toLowerCase().indexOf('ddd') != -1)
|| (str.toLowerCase().indexOf('eee') != -1)
|| (str.toLowerCase().indexOf('fff') != -1)
|| (str.toLowerCase().indexOf('ggg') != -1)
|| (str.toLowerCase().indexOf('hhh') != -1)
|| (str.toLowerCase().indexOf('iii') != -1)
|| (str.toLowerCase().indexOf('jjj') != -1)
|| (str.toLowerCase().indexOf('kkk') != -1)
|| (str.toLowerCase().indexOf('lll') != -1)
|| (str.toLowerCase().indexOf('mmm') != -1)
|| (str.toLowerCase().indexOf('nnn') != -1)
|| (str.toLowerCase().indexOf('ooo') != -1)
|| (str.toLowerCase().indexOf('ppp') != -1)
|| (str.toLowerCase().indexOf('qqq') != -1)
|| (str.toLowerCase().indexOf('rrr') != -1)
|| (str.toLowerCase().indexOf('sss') != -1)
|| (str.toLowerCase().indexOf('ttt') != -1)
|| (str.toLowerCase().indexOf('uuu') != -1)
|| (str.toLowerCase().indexOf('vvv') != -1)
|| (str.toLowerCase().indexOf('www') != -1)
|| (str.toLowerCase().indexOf('xx') != -1)
|| (str.toLowerCase().indexOf('yyy') != -1)
|| (str.toLowerCase().indexOf('zzz') != -1)
|| (str.toLowerCase().indexOf('bastard') != -1)
|| (str.toLowerCase().indexOf('fuck') != -1)
|| (str.toLowerCase().indexOf('sex') != -1)
|| (str.toLowerCase().indexOf('viagra') != -1)
|| (str.toLowerCase().indexOf('silde') != -1)
|| (str.toLowerCase().indexOf('sild') != -1)
|| (str.toLowerCase().indexOf('nafil') != -1)
|| (str.toLowerCase().endsWith("bite"))
|| (str.toLowerCase().indexOf('stupid') != -1)
|| (str.toLowerCase().indexOf('noname') != -1)
|| (str.toLowerCase().indexOf('no-name') != -1)
|| (str.toLowerCase().indexOf('unknown') != -1)
|| (str.toLowerCase().indexOf('invalid') != -1)
|| (str.toLowerCase().indexOf('notvalid') != -1)
|| (str.toLowerCase().indexOf('null') != -1)
|| (str.toLowerCase().indexOf('english') != -1)
|| (str.toLowerCase().indexOf('england') != -1)
|| (str.toLowerCase().indexOf('british') != -1)
|| (str.toLowerCase().indexOf('french') != -1)
|| (str.toLowerCase().indexOf('americ') != -1)
|| (str.toLowerCase().indexOf('german') != -1)
|| (str.toLowerCase().indexOf('deutsch') != -1)
|| (str.toLowerCase().indexOf('canad') != -1)
|| (str.toLowerCase().indexOf('myname') != -1)
|| (str.toLowerCase().indexOf('nobody') != -1)
|| (str.toLowerCase().indexOf('anybody') != -1)
|| (str.toLowerCase().indexOf('noone') != -1)
|| (str.toLowerCase().indexOf('anyone') != -1)
|| (str.toLowerCase().indexOf('noone') != -1)
|| (str.toLowerCase().indexOf('person') != -1)
|| (str.toLowerCase().indexOf('dummy') != -1)
|| (str.toLowerCase().indexOf('empty') != -1)
|| (str.toLowerCase().indexOf('empti') != -1)
|| (str.toLowerCase().indexOf('azert') != -1)
|| (str.toLowerCase().indexOf('qwert') != -1)
|| (str.toLowerCase().indexOf('masterm') != -1)
|| (str.toLowerCase().indexOf('master-m') != -1)
|| (str.toLowerCase().indexOf('supermas') != -1)
|| (str.toLowerCase().indexOf('super-mas') != -1)
|| (str.toLowerCase().indexOf('yvpj') != -1)
|| (str.toLowerCase() == "super")
|| (str.toLowerCase() == "master")
|| (str.toLowerCase() == "mind")
|| (str.toLowerCase() == "usa")
|| (str.toLowerCase() == "france")
|| (str.toLowerCase() == "allemagne")
|| (str.toLowerCase() == "francais")
|| (str.toLowerCase() == "paris")
|| (str.toLowerCase() == "berlin")
|| (str.toLowerCase() == "toto")
|| (str.toLowerCase() == "ajk")
|| (str.toLowerCase().indexOf('-') == 0)
|| (str.toLowerCase().lastIndexOf('-') == str.length - 1)
|| (str.toLowerCase().indexOf('--') != -1)
|| (str.toLowerCase().indexOf('_') != -1)
|| (nbVowels(str) == 0)
|| (nbVowels(str) == str.length) ) {
return false;
}
return true;
}

if (localStorage.firstname && (!isCorrect(localStorage.firstname))) {
localStorage.previousfirstname = localStorage.firstname;
localStorage.removeItem('firstname'); // localStorage.firstname
}

var glbScoreAndPerfHistorySize = 20; // (shall be > 5)
var glbScoreAndPerfHistoryArrayNamePrefix = "glbScoreAndPerfHistoryArray";
var glbScoreNAValue = -100; // (also used for init value in max calculation)
var glbPerfNAValue = -100; // (also used for init value in max calculation)
function getGlbScoreAndPerfHistoryArrayName(nbColumns_p) {
return glbScoreAndPerfHistoryArrayNamePrefix + "_" + nbColumns_p + "cols";
}
function storeGlbScoreAndPerf(nbColumns_p, glb_score, glb_perf) {
try {
// Check parameters
if ((nbColumns_p != 3) && (nbColumns_p != 4) && (nbColumns_p != 5) && (nbColumns_p != 6) && (nbColumns_p != 7)) {
throw new Error("invalid nbColumns_p: " + nbColumns_p);
}
var valid_glb_score = (glb_score != '-');
var glb_score_float = glbScoreNAValue;
if (valid_glb_score) {
glb_score_float = parseFloat(glb_score);
if (isNaN(glb_score_float) || !isFinite(glb_score)) {
throw new Error("invalid glb_score value: " + glb_score);
}
}
var valid_glb_perf = (glb_perf != '-');
var glb_perf_float = glbPerfNAValue;
if (valid_glb_perf) {
glb_perf_float = parseFloat(glb_perf);
if (isNaN(glb_perf_float) || !isFinite(glb_perf)) {
throw new Error("invalid glb_perf value: " + glb_perf);
}
}

// Initialize global scores and perfs in localStorage
var glbScoreAndPerfHistoryArrayName = getGlbScoreAndPerfHistoryArrayName(nbColumns_p);
var jsonString = localStorage.getItem(glbScoreAndPerfHistoryArrayName);
if (jsonString == null) {
var glbScoreAndPerfHistoryArray = new Array(glbScoreAndPerfHistorySize);
for (var i = 0; i < glbScoreAndPerfHistorySize; i++) {
glbScoreAndPerfHistoryArray[i] = {glbscore: glbScoreNAValue, glbperf: glbPerfNAValue, date: "creation date: " + new Date()};
}
var jsonString2 = JSON.stringify(glbScoreAndPerfHistoryArray);
localStorage.setItem(glbScoreAndPerfHistoryArrayName, jsonString2);
localStorage.glbScoreAndPerfHistoryIdx = 0;
}

// Get global scores and perfs in localStorage
jsonString = localStorage.getItem(glbScoreAndPerfHistoryArrayName);
if (jsonString == null) {
throw new Error("null jsonString");
}
var glbScoreAndPerfHistoryArray = JSON.parse(jsonString);
if (glbScoreAndPerfHistoryArray.length != glbScoreAndPerfHistorySize) {
throw new Error("invalid length: " + glbScoreAndPerfHistoryArray.length + " != " + glbScoreAndPerfHistorySize);
}
var glbScoreAndPerfHistoryIdx = parseInt(localStorage.glbScoreAndPerfHistoryIdx);
if (isNaN(glbScoreAndPerfHistoryIdx) || (glbScoreAndPerfHistoryIdx < 0) || (glbScoreAndPerfHistoryIdx >= glbScoreAndPerfHistorySize)) {
throw new Error("invalid global history index: " + glbScoreAndPerfHistoryIdx);
}

// Update global scores and perfs in localStorage
glbScoreAndPerfHistoryArray[glbScoreAndPerfHistoryIdx] = { glbscore: glb_score_float, // (glbScoreNAValue if !valid_glb_score)
glbperf: glb_perf_float, // (glbPerfNAValue if !valid_glb_perf)
date: new Date() };
var jsonString2 = JSON.stringify(glbScoreAndPerfHistoryArray);
localStorage.setItem(glbScoreAndPerfHistoryArrayName, jsonString2);
localStorage.glbScoreAndPerfHistoryIdx = (glbScoreAndPerfHistoryIdx + 1) % glbScoreAndPerfHistorySize;
}
catch (exc) {
submitForm("storeGlbScoreAndPerf error: " + exc + ": " + exc.stack, 50);
}
}

function displayOrGetMaxGlbScoreAndPerf(nbColumns_p, display, maxGlbResultsOut) {
if (!display) {
maxGlbResultsOut.glbscore = glbScoreNAValue;
maxGlbResultsOut.glbperf = glbPerfNAValue;
}
try {
var glbScoreAndPerfHistoryArrayName = getGlbScoreAndPerfHistoryArrayName(nbColumns_p);
var jsonString = localStorage.getItem(glbScoreAndPerfHistoryArrayName);
if (jsonString == null) {
return false; // array not yet initialized
}
var glbScoreAndPerfHistoryArray = JSON.parse(jsonString);
if (glbScoreAndPerfHistoryArray.length != glbScoreAndPerfHistorySize) {
throw new Error("displayOrGetMaxGlbScoreAndPerf: invalid length: " + glbScoreAndPerfHistoryArray.length + " != " + glbScoreAndPerfHistorySize);
}
var glbScoreAndPerfHistoryIdx = parseInt(localStorage.glbScoreAndPerfHistoryIdx);
if (isNaN(glbScoreAndPerfHistoryIdx) || (glbScoreAndPerfHistoryIdx < 0) || (glbScoreAndPerfHistoryIdx >= glbScoreAndPerfHistorySize)) {
throw new Error("displayOrGetMaxGlbScoreAndPerf: invalid global history index: " + glbScoreAndPerfHistoryIdx);
}
if (display) { // display mode
for (var i = 0; i < glbScoreAndPerfHistorySize; i++) {
console.log("[" + i + ((i == glbScoreAndPerfHistoryIdx) ? "*": "") + "] " + glbScoreAndPerfHistoryArray[i].glbscore + ", " + glbScoreAndPerfHistoryArray[i].glbperf + ", " + glbScoreAndPerfHistoryArray[i].date);
}
}
else { // "get max" mode
if (!localStorage.gamesok || (Number(localStorage.gamesok) < glbScoreAndPerfHistorySize + 5)) { // (simplified check for all column numbers)
console.log("(displayOrGetMaxGlbScoreAndPerf: skipped)");
return false;
}
var maxGlbScore = glbScoreNAValue;
var maxGlbPerf = glbPerfNAValue;
for (var i = 0; i < glbScoreAndPerfHistorySize; i++) {
if (glbScoreAndPerfHistoryArray[i].glbscore > maxGlbScore) {
maxGlbScore = glbScoreAndPerfHistoryArray[i].glbscore;
}
if (glbScoreAndPerfHistoryArray[i].glbperf > maxGlbPerf) {
maxGlbPerf = glbScoreAndPerfHistoryArray[i].glbperf;
}
}
maxGlbResultsOut.glbscore = maxGlbScore; // (can be glbScoreNAValue)
maxGlbResultsOut.glbperf = maxGlbPerf; // (can be glbPerfNAValue)
return true;
}
}
catch (exc) {
submitForm("(displayOrGetMaxGlbScoreAndPerf: exception: " + exc + ": " + exc.stack + ")", 60);
return false;
}
return false;
}

var trophy_image = new Image(); // create an image object
var trophy_image_loaded = false;
var trophy_image_width = -1;
var trophy_image_height = -1;
if (!firefoxMode) { // poor display of trophy image
trophy_image.src = "img/trophy.png"; // asynchronous image load - this image will only be loaded once and used several times
}
trophy_image.onload = function() {
trophy_image_loaded = true;
trophy_image_width = trophy_image.width;
trophy_image_height = trophy_image.height;
}

function handle_rsp_delayed(e) {
debug_game_state = 80;
try {
if ( (e !== undefined) && (e != null)
&& (typeof e.rsp_cd == 'undefined') // rsp_cd means error
&& (typeof e.rankings !== 'undefined') && (e.rankings.length > 10)
&& (typeof e.nbcolumns !== 'undefined') && (typeof e.globalScore !== 'undefined') && (typeof e.globalPerf !== 'undefined') ) {

if (e.nbcolumns != "NA") {
storeGlbScoreAndPerf(e.nbcolumns, e.globalScore, e.globalPerf);
}

var rsp_rankings_str = JSON.stringify(e.rankings).replaceAll("^\"|\"$", ""); // (suppress leading and ending double quotes)
// console.log("1: " + rsp_rankings_str);

// Uncompress rankings HTML code
if (rsp_rankings_str.indexOf("</tr>") == -1) { // complete </tr> for proper row formating
rsp_rankings_str = rsp_rankings_str.replaceAll("<tr", "</tr><tr");
rsp_rankings_str = rsp_rankings_str.replace("</table>", "</tr></table>");
rsp_rankings_str = rsp_rankings_str.replace("</tr><tr", "<tr"); // (first occurrence)
}
rsp_rankings_str = rsp_rankings_str.replaceAll("<1>", "&#9990;"); // special character 1 (android app indicator)
rsp_rankings_str = rsp_rankings_str.replaceAll("<2>", "&#x2234;"); // special character 2
rsp_rankings_str = rsp_rankings_str.replaceAll("<3>", "&#x2009;"); // special character 3 (thin space)
rsp_rankings_str = rsp_rankings_str.replaceAll("<4>", "&#x266C;"); // special character 4 (random play)
rsp_rankings_str = rsp_rankings_str.replaceAll("<5>", "&nbsp;"); // special character 5 (space)
rsp_rankings_str = rsp_rankings_str.replaceAll("<table>", "<table id='score_table' style='border:0;padding:0;border-collapse:collapse;width:TABLE_WIDTH;'>");
rsp_rankings_str = rsp_rankings_str.replaceAll("<tr>", "<tr style='font-size:FTZ;white-space:nowrap'>");
rsp_rankings_str = rsp_rankings_str.replace(/<tr([A-Za-z0-9]+)>/g, "<tr style='background-color:#$1;font-size:FTZ;white-space:nowrap'>");
rsp_rankings_str = rsp_rankings_str.replace(/<hr([A-Za-z0-9.]+)>/g, "<hr style='height:$1vh;padding:0;margin:0;visibility:hidden;'>");

rsp_rankings_str = rsp_rankings_str.replaceAll("width:TABLE_WIDTH", "width:" + scoresTableWidthStr);
var header_font_size = "2.7vh";
var header_font_size_for_img = "3.2vh";
rsp_rankings_str = rsp_rankings_str.replaceAll("font-size:HEADER_FTZ", "font-size:" + header_font_size);
if (trophy_image_loaded) {
rsp_rankings_str = rsp_rankings_str.replace("&#x1F3C6;" /* trophy */,
"<img id='score_trophy_image_id_1' style='vertical-align:middle;height:" + header_font_size_for_img + ";margin:0;padding:0;'>");
rsp_rankings_str = rsp_rankings_str.replace("&#x1F3C6;" /* trophy */,
"<img id='score_trophy_image_id_2' style='vertical-align:middle;height:" + header_font_size_for_img + ";margin:0;padding:0;'>");
} // else: keep unicode characters
rsp_rankings_str = rsp_rankings_str.replaceAll("font-size:FTZ", "font-size:" + scoresFontSizeStr);
let padding_str = "0.3vh 0 0.3vh 0";
rsp_rankings_str = rsp_rankings_str.replaceAll("<td>", "<td style='vertical-align:middle;border:0;margin:0;padding:" + padding_str + ";text-align:center;font-weight:bold;'>"); // actual <td> syntax is applied
rsp_rankings_str = rsp_rankings_str.replace(/[\[]/g, "<td style='vertical-align:middle;border:0;margin:0;padding:" + padding_str + ";text-align:center;font-weight:bold;'>"); // actual <td> syntax is applied: "[" -> "<td ...>" / case without background image
rsp_rankings_str = rsp_rankings_str.replace(/[\]]/g, "</td>"); // actual </td> syntax is applied: "]" -> "</td>"
rsp_rankings_str = rsp_rankings_str.replaceAll("<s>", "<small>"); // "<s>" -> "<small>"
rsp_rankings_str = rsp_rankings_str.replaceAll("</s>", "</small>"); // "</s>" -> "</small>"
rsp_rankings_str = rsp_rankings_str.replace(/(\([0-9]+\))/g, "<font color=#555555>$1</font>"); // apply color change on numbers of assessed attempts
rsp_rankings_str = rsp_rankings_str.replace(/(<tr((?!<td).)*<td style=\')/g, "$1border-radius:0.8vh 0 0 0.8vh;"); // make left borders round  ("?!" means "does not contain")
rsp_rankings_str = rsp_rankings_str.replace(/(<td style=\')(((?!<td).)*<\/tr)/g, "$1border-radius:0 0.8vh 0.8vh 0;$2"); // make right borders round ("?!" means "does not contain")
rsp_rankings_str = rsp_rankings_str.replace("HISTORY_SIZE", glbScoreAndPerfHistorySize);

// console.log("2: " + rsp_rankings_str);
// Rk: top scores are always displayed, even if current game score is not in them
try {
modal_mode = 2;
// set modal content
modal.setContent("<div style='-webkit-touch-callout: none; /* iOS Safari */ -webkit-user-select: none; /* Safari */ -khtml-user-select: none; /* Konqueror HTML */ -moz-user-select: none; /* Firefox */ -ms-user-select: none; /* Internet Explorer/Edge */ user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */'>"
+ rsp_rankings_str
+ "</div>");
// open modal
modal.open();

// point to already-loaded images
let trophy_img_1 = document.getElementById('score_trophy_image_id_1');
if (trophy_img_1 != null) {
trophy_img_1.src = "img/trophy.png";
}
let trophy_img_2 = document.getElementById('score_trophy_image_id_2');
if (trophy_img_2 != null) {
trophy_img_2.src = "img/trophy.png";
}
}
catch (exc) {
throw new Error("modal error (" + modal_mode + "): " + exc + ": " + exc.stack);
}
}
else {
if ((e == undefined) || (e == null)) {
console.log('rsp_cd: ?');
}
else if (typeof e.rsp_cd !== 'undefined') {
console.log('rsp_cd: ' + JSON.stringify(e.rsp_cd));
}
else {
console.log('rsp_cd: ?');
}
}
}
catch (exc) {
throw new Error("handle_rsp_delayed error: " + exc + ": " + exc.stack);
}
debug_game_state = 81;
}
var last_game_was_short = false;
function handle_rsp(e) { // CALLED BY GS SCRIPT
console.log("(handle_rsp)");
localStorage.last_handle_rsp_call = (new Date()).getTime();

var score_display_time = 4444; // (see blinking time)
if (mobileMode) {
score_display_time = 4444; // (see blinking time)
}
if (last_game_was_short && (nbGamesPlayedAndWon >= 2) && localStorage.gamesok && (Number(localStorage.gamesok) >= 10)) {
score_display_time = score_display_time * 2 + 3000; // extra time when short games
}

var time_to_wait = 44;
var time_diff = new Date().getTime() - store_time; // (can be negative)
if (time_diff < score_display_time) {
time_to_wait = score_display_time - time_diff;
}
else {
time_to_wait = 44; // (no time to wait, form submission was long enough)
}
console.log("(time_diff=" + time_diff + ", time_to_wait=" + time_to_wait + ")");
setTimeout("handle_rsp_delayed(" + JSON.stringify(e) + ");", time_to_wait);
}

var statsURL = "https://script.google.com/macros/s/AKf" + extraStr + "ycbxV_dIUQ-wfdjGxHLzsEvVDp3MHMzggA9e20Td1jiSQZJXvgVvgFr_kbOE0IL4cXTyo/exec";
var last_stats_keys_size = 50;
var last_stats_keys_index = 0;
var last_stats_keys = new Array(last_stats_keys_size);
for (var i = 0; i < last_stats_keys_size; i++) {
last_stats_keys[i] = "__init_stats_key__";
}
function handle_stats(nbColumns_p, totalTime_p, calcTime_p, applyTimes_p, pId_p, key_p, retr_p) { // CALLED BY THIS SCRIPT (Y2) OR BY GS SCRIPT (N or Y)
setTimeout("handle_stats_bis(" + nbColumns_p + ", " + totalTime_p + ", " + calcTime_p + ", '" + applyTimes_p + "', '" + pId_p + "', '" + key_p + "', '" + retr_p + "');", 44);
}
function handle_stats_bis(nbColumns_p, totalTime_p, calcTime_p, applyTimes_p, pId_p, key_p, retr_p) {

// console.log("handle_stats_bis: " + nbColumns_p + ", " + totalTime_p + ", " + calcTime_p + ", " + applyTimes_p + ", " + pId_p + ", " + key_p + ", " + retr_p);
if (globalErrorStatus) { // skip handle_stats_bis when a basic global error occurred
console.log("(handle_stats_bis skipped due to global error)");
return;
}

// Check parameters
if ( ((nbColumns_p != "4") && (nbColumns_p != "5") && (nbColumns_p != "6") && (nbColumns_p != "7"))
|| ((applyTimes_p != "N") && (applyTimes_p != "Y"))
|| ((retr_p != "N") && (retr_p != "Y") && (retr_p != "Y2")) ) {
submitForm("handle_stats_bis error (wrong parameters): " + nbColumns_p + ", " + totalTime_p + ", " + calcTime_p + ", "
+ applyTimes_p + ", " + pId_p + ", " + key_p  + ", " + retr_p + ", last_idx: " + last_stats_keys_index, 70);
console.log("stats form submission skipped (wrong parameters)");
return; // skip stats update
}

// Check that stats were not already taken into account
for (var i = 0; i < last_stats_keys_size; i++) {
if (last_stats_keys[i] == key_p) {
console.log("stats form submission skipped (duplicate key)");
return; // skip stats update
}
}
last_stats_keys[last_stats_keys_index] = key_p;
last_stats_keys_index++;
if (last_stats_keys_index >= last_stats_keys_size) {
last_stats_keys_index = 0;
}

var my_stats_form_url = statsURL;
var my_stats_params = {};
my_stats_params['col'] = nbColumns_p;
my_stats_params['tottime'] = totalTime_p;
my_stats_params['calctime'] = calcTime_p;
my_stats_params['applytimes'] = applyTimes_p;
my_stats_params['pid'] = pId_p;
my_stats_params['loc'] = getLocation();
my_stats_params['v'] = html_compatibility_game_version;
my_stats_params['retr'] = retr_p; // --> stats on retries
/* ... my_stats_params['key'] = key_p */
// (See reasons above in this file)
replaceAllElementsInStruct(my_stats_params, "\n", " "); // (duplicated code)
replaceAllElementsInStruct(my_stats_params, "\r", ""); // (duplicated code)
replaceAllElementsInStruct(my_stats_params, "\t", " "); // (duplicated code)
if (!beforeunload_case) {
$.ajax({
crossDomain: true,
url: my_stats_form_url,
data: my_stats_params,
method: 'GET',
dataType: 'jsonp',
timeout: 30000 // 30 seconds
});
}
else { // specific beforeunload case => save last stats command (only the very last command to simplify)
if (retr_p != "Y2") {
submitForm("internal error when setting localStorage.pendingStats: " + retr_p, 80);
}
localStorage.pendingStats = "handle_stats_bis(" + nbColumns_p + ", " + totalTime_p + ", " + calcTime_p + ", '" + applyTimes_p + "', '" + pId_p + "', '" + key_p + "', '" + retr_p + "');"
}

}
if (localStorage.pendingStats) { // Executed once at startup: check if there were pending stats
setTimeout("console.log('pending stats handled');" + localStorage.pendingStats + "localStorage.removeItem('pendingStats');", 4444); // localStorage.pendingStats
}

var globalProgressForHTMLGame2 = getGlobalProgress(0.75 /* (rough value) */, 0);
console.log("current progress: " + Math.max(globalProgressForHTMLGame2, lastGlobalProgress) + "% (g)"); lastGlobalProgress = globalProgressForHTMLGame2; // !WARNING! -> this console text will be read by the android app so shall not be modified
if (globalProgressForHTMLGame2 > 0) {
$("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgressForHTMLGame2 + "%)"); // (not rem unit as no viewport! / duplicated code)
}

var nb_locationURL_accesses = 0;
var locationURL_accesses_failure_causes = "";

function reformatLocationValue(x) {
let res = String(x).trim();
if ((typeof x == 'undefined') || (x == undefined) || (x == null) || (res == "")) {
return '-';
}
else {
return res;
}
}

function reformatTime(time_in_ms) {
if (time_in_ms < 0) {
return "negativetime:" + time_in_ms/1000;
}
let time_in_sec = Math.floor(time_in_ms/1000);
let time_in_minutes = Math.floor(time_in_sec / 60);
let time_in_hours = Math.floor(time_in_sec / 3600 * 10)/10;
let time_in_days = Math.floor(time_in_sec / (24 * 3600) * 100)/100;
if (time_in_days >= 1) {
return time_in_days + "d";
}
else if (time_in_hours >= 1) {
return time_in_hours + "h";
}
else if (time_in_minutes > 0) {
let remaining_sec = Math.floor((time_in_sec - time_in_minutes*60)/10)*10;
return time_in_minutes + "min" + ((time_in_minutes < 5) && (remaining_sec != 0) ? remaining_sec + "s" : "");
}
else {
return time_in_sec + "s";
}
}

function deg2rad(deg) {
return deg * (Math.PI/180);
}
function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
var R = 6371; // Radius of the earth in km
var dLat = deg2rad(lat2-lat1);
var dLon = deg2rad(lon2-lon1);
var a =
Math.sin(dLat/2) * Math.sin(dLat/2) +
Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
Math.sin(dLon/2) * Math.sin(dLon/2);
var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
var d = R * c; // Distance in km
return d;
}

let dummyLocationPrefix1 = "/1:";
let dummyLocationPrefix2 = "/2:";
let dummyLocationPrefix3 = "/3:";
let dummyLocationPrefix4 = "/4:";
let dummyLocationPrefix5 = "/5:";
function isLocationDataValid(data_p, check_region_instead_of_city = false) {
if ((typeof data_p == 'undefined') || (data_p == undefined) ||  (data_p == null)) { // (condition duplicated)
return false;
}
let validIpAddress = ((typeof data_p.ip != 'undefined') && (data_p.ip != undefined) && (data_p.ip != null) && ((String(data_p.ip).indexOf(".") != -1) || (String(data_p.ip).indexOf(":") != -1)) && (String(data_p.ip).trim().length >= 7 /* 0.0.0.0 */)); // (condition duplicated - covers IPv4 and IPv6)
let validCountryName = ((typeof data_p.country_name != 'undefined') && (data_p.country_name != undefined) && (data_p.country_name != null) && (data_p.country_name.length >= 2) /* covers country name abbreviations which are 2 characters long */);
let cityOrRegionCondition;
if (!check_region_instead_of_city) {
// Note: city may be known whereas region is not
cityOrRegionCondition = ((typeof data_p.city != 'undefined') && (data_p.city != undefined) && (data_p.city != null) && (data_p.city.length >= 2) && (reformatLocationValue(data_p.city) != "-") && (reformatLocationValue(data_p.city).toLowerCase() != "city") && (reformatLocationValue(data_p.city).toLowerCase() != "ville") && (reformatLocationValue(data_p.city).toLowerCase() != "undefined"));
}
else {
cityOrRegionCondition = ((typeof data_p.region != 'undefined') && (data_p.region != undefined) && (data_p.region != null) && (data_p.region.length >= 2) && (reformatLocationValue(data_p.region) != "-") && (reformatLocationValue(data_p.region).toLowerCase() != "region") && (reformatLocationValue(data_p.region).toLowerCase() != "rgion") && (reformatLocationValue(data_p.region).toLowerCase() != "undefined"));
}
if ( (typeof data_p.latitude != 'undefined') && (data_p.latitude != undefined) && (data_p.latitude != null)
&& (typeof data_p.longitude != 'undefined') && (data_p.longitude != undefined)  && (data_p.longitude != null)
&& ((String(data_p.latitude).indexOf('.') != -1) || (String(data_p.longitude).indexOf('.') != -1))
&& validCountryName
&& cityOrRegionCondition
&& validIpAddress) {
return true;
}
return false;
}

function getPreciseStoredLocationData() {
if (localStorage.precise_latitude && localStorage.precise_longitude && localStorage.precise_accuracy && localStorage.precise_countryname && localStorage.precise_region && localStorage.precise_city && localStorage.precise_ip && localStorage.precise_location_success_time) {
let precise_location_data = { latitude: localStorage.precise_latitude,
longitude: localStorage.precise_longitude,
accuracy: localStorage.precise_accuracy,
country_name: localStorage.precise_countryname,
region: localStorage.precise_region,
city: localStorage.precise_city,
ip: localStorage.precise_ip };
return precise_location_data;
}
else {
return null;
}
}

function setStoredLocationData(ipaddress, locationId, latitude, longitude, country, region, city) {
localStorage.bestEffortIPAddress = reformatLocationValue(ipaddress);
localStorage.bestEffortIPAddressSource = locationId;
localStorage.bestEffortIPAddressStorageTime = (new Date()).getTime();

localStorage.latitude = reformatLocationValue(latitude); // (local storage of most useful location information)
localStorage.longitude = reformatLocationValue(longitude);
localStorage.accuracy = '?';
localStorage.countryname = reformatLocationValue(country);
localStorage.region = reformatLocationValue(region);
localStorage.city = reformatLocationValue(city);
localStorage.ip = reformatLocationValue(ipaddress);
localStorage.location_id = locationId; // location id associated to those stored location values
localStorage.location_storage_time = (new Date()).getTime(); // time associated to those stored location values
}

function getStoredLocationData() {
if (localStorage.latitude && localStorage.longitude && localStorage.accuracy && localStorage.countryname && localStorage.region && localStorage.city && localStorage.ip && localStorage.location_id && localStorage.location_storage_time) { // (condition duplicated)
let stored_location_data = { latitude: localStorage.latitude,
longitude: localStorage.longitude,
accuracy: localStorage.accuracy,
country_name: localStorage.countryname,
region: localStorage.region,
city: localStorage.city,
ip: localStorage.ip };
return stored_location_data;
}
else {
return null;
}
}

let city_name_to_be_skipped = "skip_me";
function setBestEffortLocationData(data_p, locationId) {
try {
if (isLocationDataValid(data_p)) { // best effort location shall not be valid
throw new Error("setBestEffortLocationData called on valid location data");
}
try {
// (always attempt to update localStorage.best_effort_countryname, at least for debug purposes)
localStorage.best_effort_countryname = data_p.country_name;
}
catch (exc) {}
// Consider region instead of city
if (isLocationDataValid(data_p, true /* check_region_instead_of_city */)) {
localStorage.bestEffortIPAddress = reformatLocationValue(data_p.ip);
localStorage.bestEffortIPAddressSource = locationId;
localStorage.bestEffortIPAddressStorageTime = (new Date()).getTime();

localStorage.best_effort_latitude = reformatLocationValue(data_p.latitude);
localStorage.best_effort_longitude = reformatLocationValue(data_p.longitude);
localStorage.best_effort_accuracy = '?';
localStorage.best_effort_countryname = reformatLocationValue(data_p.country_name);
localStorage.best_effort_region = reformatLocationValue(data_p.region); // region instead of city
localStorage.best_effort_city = city_name_to_be_skipped; // region instead of city
localStorage.best_effort_ip = reformatLocationValue(data_p.ip);
localStorage.best_effort_location_id = locationId; // location id associated to those stored location values
localStorage.best_effort_update_time = (new Date()).getTime(); // time associated to those stored location values
// Defensive check
let best_effort_location_data = getBestEffortLocationData();
if (!isLocationDataValid(best_effort_location_data)) { // shall be valid thanks to city_name_to_be_skipped
throw new Error("setBestEffortLocationData: invalid best effort location data: " + JSON.stringify(best_effort_location_data));
}
}
}
catch (exc) {
submitForm("setBestEffortLocationData error: " + exc + ": " + exc.stack, 90);
}
}

function getBestEffortLocationData() {
if (localStorage.best_effort_latitude && localStorage.best_effort_longitude && localStorage.best_effort_accuracy && localStorage.best_effort_countryname && localStorage.best_effort_region && localStorage.best_effort_city && localStorage.best_effort_ip && localStorage.best_effort_location_id && localStorage.best_effort_update_time) {
let best_effort_location_data = { latitude: localStorage.best_effort_latitude,
longitude: localStorage.best_effort_longitude,
accuracy: localStorage.best_effort_accuracy,
country_name: localStorage.best_effort_countryname,
region: localStorage.best_effort_region,
city: localStorage.best_effort_city,
ip: localStorage.best_effort_ip };
return best_effort_location_data;
}
else {
return null;
}
}

let GEOCODING_API_URL_1 = "https://geocode.maps.co/reverse?lat=LATITUDE&lon=LONGITUDE&api_key=65b" + extraStr + "bd7330aa0a629386831xwm917" + "233";
let GEOCODING_API_URL_2 = "https://nominatim.openstreet" + extraStr + "map.org/reverse?lat=LATITUDE&lon=LONGITUDE&format=json&accept-language=en";
if (!localStorage.useFirstGeocodingApi) {
localStorage.useFirstGeocodingApi = "yes";
}
function HTML_geolocation_success(position, debug_str_p = null) { // CALLED BY ANDROID APP (with debug_str_p parameter filled)
let latitude = position.coords.latitude;
let longitude = position.coords.longitude;
let accuracy = position.coords.accuracy; // (in meters)
console.log("HTML geolocation success:");
console.log(" latitude: " + latitude);
console.log(" longitude: " + longitude);
console.log(" accuracy: " + accuracy);

debug_game_state = 10;
let debug_str = "";
if (debug_str_p != null) {
debug_str = " " + debug_str_p;
}
debug_str = debug_str + " " + ((localStorage.useFirstGeocodingApi == "yes") ? "1stGeolocApi" : "2ndGeolocApi");
localStorage.html_geoloc_status = "run_bis" + debug_str;
HTML_geoloc_successes++;

// Best effort or unknown IP address
let inferred_ip_address = (localStorage.bestEffortIPAddress ? localStorage.bestEffortIPAddress : unknownIPAddressPrefix + '1.' /* 0.0.01.xxxxx */ + Math.floor(Math.random() * 99999999) /* 99999999 dummy ip addresses */);
// Attempt to refresh (old or non-existing) localStorage.bestEffortIPAddress IP address
if ( (!localStorage.bestEffortIPAddress)
|| (!localStorage.bestEffortIPAddressStorageTime) || ((new Date()).getTime() - localStorage.bestEffortIPAddressStorageTime > 3*24*3600*1000) ) { // 3 days
if ( (!localStorage.bestEffortIPAddressAttemptTime) || ((new Date()).getTime() - localStorage.bestEffortIPAddressAttemptTime > 1*24*3600*1000) ) { // 1 day
setTimeout("attemptAlternateLocationMethods(true);" /* ip_address_only */, 4444); // asynchronous to simplify
localStorage.bestEffortIPAddressAttemptTime = (new Date()).getTime();
}
}

// Do not trigger useless geocoding requests
let precise_location_data = getPreciseStoredLocationData();
if ( isLocationDataValid(precise_location_data)
&& (getDistanceFromLatLonInKm(precise_location_data.latitude, precise_location_data.longitude, latitude, longitude) < 0.250) ) { // nearly same position as previous one
console.log("previously stored precise location reused");
localStorage.precise_ip = inferred_ip_address;
localStorage.precise_location_success_time = (new Date()).getTime();
localStorage.html_geoloc_status = "ok nearly same position" + debug_str;
precise_location_data = getPreciseStoredLocationData();
if (!isLocationDataValid(precise_location_data)) {
throw new Error("HTML_geolocation_success: invalid precise location data #1: " + JSON.stringify(precise_location_data));
}
return;
}

if (localStorage.precise_geolocation_api_access_time && ((new Date()).getTime() - localStorage.precise_geolocation_api_access_time < (android_appli ? 1.5 : 36)*3600*1000)) { // condition duplicated 3 times - defense for restarts + android app calls (after restarts)
console.log("HTML geolocation skipped");
localStorage.html_geoloc_status = "skipped" + debug_str;
return;
}
localStorage.precise_geolocation_api_access_time = (new Date()).getTime();

let GEOCODING_API_URL = ((localStorage.useFirstGeocodingApi == "yes") ? GEOCODING_API_URL_1 : GEOCODING_API_URL_2);
GEOCODING_API_URL = GEOCODING_API_URL.replace("LATITUDE", latitude).replace("LONGITUDE", longitude);
$.getJSON(GEOCODING_API_URL)
.done(function(location) {
debug_game_state = 11;
try {
// location.error and other below location.x field checks are valid for both geocode and nominatim JSON syntaxes => no localStorage.useFirstGeocodingApi checks are needed
if (location.error == undefined) { // geocoding API success
let country = "-";
if (location.address.country) {
country = String(location.address.country).trim();
}
let region = "-"; // invalid value by default
if (location.address.state) { // (can be best known than county)
region = String(location.address.state).trim();
}
else if (location.address.county) {
region = String(location.address.county).trim();
}
else if (location.address.region) {
region = String(location.address.region).trim();
}
let city = "-"; // invalid value by default
if (location.address.town) {
city = String(location.address.town).trim();
}
else if (location.address.city) {
city = String(location.address.city).trim();
}
else if (location.address.municipality) {
city = String(location.address.municipality).trim();
}
else if (location.address.village) { // (can be too precise for android approximate location permission)
city = String(location.address.village).trim();
}
let zip = "-";
if (location.address.postcode) {
zip = String(location.address.postcode).trim();
}

console.log(" country: " + country);
console.log(" region: " + region);
console.log(" city: " + city);
console.log(" zip: " + zip);

var tmp_location_data = { latitude: reformatLocationValue(latitude),
longitude: reformatLocationValue(longitude),
accuracy: accuracy,
country_name: reformatLocationValue(country),
region: reformatLocationValue(region),
city: reformatLocationValue(city),
ip: inferred_ip_address };
if (isLocationDataValid(tmp_location_data)) {
console.log("new precise location stored");
localStorage.precise_latitude = tmp_location_data.latitude;
localStorage.precise_longitude = tmp_location_data.longitude;
localStorage.precise_accuracy = tmp_location_data.accuracy;
localStorage.precise_countryname = tmp_location_data.country_name;
localStorage.precise_region = tmp_location_data.region;
localStorage.precise_city = tmp_location_data.city;
localStorage.precise_ip = tmp_location_data.ip;
localStorage.precise_location_success_time = (new Date()).getTime();
localStorage.html_geoloc_status = "ok-geocoding" + debug_str + " (" + latitude + "|" + longitude + ")";
precise_location_data = getPreciseStoredLocationData();
if (!isLocationDataValid(precise_location_data)) {
throw new Error("HTML_geolocation_success: invalid precise location data #2: " + JSON.stringify(precise_location_data));
}
}
else {
console.log("HTML geolocation error: invalid location values");
localStorage.html_geoloc_status = "ok-invalid" + debug_str + " (" + latitude + "," + longitude + ")";
}
}
else {
console.log("HTML geolocation error: location.error: " + location.error);
localStorage.html_geoloc_status = "nok-2/" + location.error + "," + debug_str + " (" + latitude + "," + longitude + ")";
localStorage.useFirstGeocodingApi = ((localStorage.useFirstGeocodingApi == "yes") ? "no" : "yes");
}
}
catch (exc) {
console.log("HTML geolocation error: " + exc);
localStorage.html_geoloc_status = "nok-3/" + exc + debug_str;
localStorage.useFirstGeocodingApi = ((localStorage.useFirstGeocodingApi == "yes") ? "no" : "yes");
}
debug_game_state = 12;
})
.fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
debug_game_state = 13;
console.log(("HTML geolocation failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
localStorage.html_geoloc_status = "nok-4" + debug_str + " " + GEOCODING_API_URL;
localStorage.useFirstGeocodingApi = ((localStorage.useFirstGeocodingApi == "yes") ? "no" : "yes");
debug_game_state = 14;
});
} // HTML_geolocation_success

let android_HTML_geolocation_retries_after_error = 0;
function HTML_geolocation_error(error) { // CALLED BY ANDROID APP (with string parameter)
let error_str = "?";
if (error.code != undefined) {
switch(error.code) {
case error.PERMISSION_DENIED:
if (!localStorage.html_geoloc_denied) {
localStorage.html_geoloc_denied = 0;
}
localStorage.html_geoloc_denied = Number(localStorage.html_geoloc_denied) + 1;
error_str = "user denied the request for geolocation/" + localStorage.html_geoloc_denied + "x";
break;
case error.POSITION_UNAVAILABLE:
error_str = "location information is unavailable";
break;
case error.TIMEOUT:
error_str = "the request to get user location timed out";
break;
case error.UNKNOWN_ERROR:
error_str = "an unknown error occurred";
break;
}
}
else { // android app call
error_str = String(error);
}
console.log("HTML geolocation error: " + error_str);
localStorage.html_geoloc_status = "nok-5/" + error_str;
HTML_geoloc_errors++;
if (android_appli /* no popups for android app */ && (android_HTML_geolocation_retries_after_error < 3)) { // retry after some geolocation attempt failures
if (!localStorage.precise_geolocation_api_access_time || !((new Date()).getTime() - localStorage.precise_geolocation_api_access_time < (android_appli ? 1.5 : 36)*3600*1000)) { // condition duplicated 3 times
android_HTML_geolocation_retries_after_error++;
setTimeout("attempt_HTML_geolocation();", 5*android_HTML_geolocation_retries_after_error*60*1000); // n*5 minutes
}
}
} // HTML_geolocation_error

let my_position = null;
function attempt_HTML_geolocation() {

if (globalErrorStatus) { // skip attempt_HTML_geolocation when a basic global error occurred
console.log("(attempt_HTML_geolocation skipped due to global error)");
return;
}

console.log("(attempt HTML geolocation at " + new Date() + ")");
if (android_appli) {
if (scriptsFullyLoaded) {
// In case of android app, classical calls to navigator.geolocation functions often do not work (unexpected timeout errors)
// => request location explicitly to the android app which will call HTML_geolocation_success or HTML_geolocation_error
console.log("(get last location request)"); // !WARNING! -> this console text will be read by the android app so shall not be modified
HTML_geoloc_attempts++;
localStorage.html_geoloc_status = "run_app";
}
else {
localStorage.html_geoloc_status = "run_app_skipped";
}
}
else {
localStorage.html_geoloc_status = "run";
if (navigator.geolocation) {
// Subject to user acceptance
// Version 1:
navigator.geolocation.getCurrentPosition(HTML_geolocation_success, HTML_geolocation_error);
HTML_geoloc_attempts++;
// Version 2 (support of location updates & more precise than getCurrentPosition() because several iterations are made):
/* let my_geolocation = navigator.geolocation.watchPosition(
function (position) { // success callback (called N times)
my_position = {coords: {latitude: position.coords.latitude, longitude: position.coords.longitude, accuracy: position.coords.accuracy}};
console.log('HTML geolocation iteration (latitude: ' + position.coords.latitude + ', ' + 'longitude: ' + position.coords.longitude + ', ' + 'accuracy: ' + position.coords.accuracy + ")");
},
HTML_geolocation_error, // error callback
{
maximumAge: 250, // (do not use cache for long)
enableHighAccuracy: true,
timeout: 15000 // (see other timeout value below)
}
);
setTimeout(function() {
navigator.geolocation.clearWatch(my_geolocation); // stop further HTML geolocation iterations (i.e. further calls to watchPosition())
console.log("stop HTML geolocation iterations");
if (my_position != null) { // (at least one HTML geolocation success during the iterations)
HTML_geolocation_success(my_position); // (use last success's position)
}
},
15300 // stop further HTML geolocation iterations (see other timeout value above / And on laptops, this timeout value will "limit the time" the user has to answer yes/no to "ok to share position?")
); */
}
}
}

let ip_address_for_alternate_loc_methods = "-";
function handle_gs_geoloc(e) { // CALLED BY GS SCRIPT
console.log("(handle_gs_geoloc)");

if (e.rsp_cd != undefined) { // rsp_cd means error
localStorage.alternateLocationMethodDebugInfo += "_gslocerr2:" + e.rsp_cd;
return;
}

let converted_data = { latitude: e.latitude,
longitude: e.longitude,
accuracy: e.accuracy,
country_name: e.country_name,
region: e.region,
city: e.city,
ip: e.ip };
if (e.ip != ip_address_for_alternate_loc_methods) {
submitForm("unexpected IP address in handle_gs_geoloc: " + e.ip + ", " + ip_address_for_alternate_loc_methods, 100);
return;
}
if (isLocationDataValid(converted_data)) {
console.log("(attempt alternate location method - success)");
console.log(converted_data);
localStorage.alternateLocationMethodDebugInfo += "_gslocok";
setStoredLocationData(converted_data.ip, alternateLocationId, converted_data.latitude, converted_data.longitude, converted_data.country_name, converted_data.region, converted_data.city);
}
else {
setBestEffortLocationData(converted_data, alternateLocationId);
localStorage.alternateLocationMethodDebugInfo += "_gslocinvalid";
}
}

if (!localStorage.alternateLocationMethodDebugInfo) {
localStorage.alternateLocationMethodDebugInfo = "altloc_never_run";
}
var xhr_loc;
function attemptAlternateLocationMethods(ip_address_only) {
try {
localStorage.alternateLocationMethodDebugInfo = "altloc_";
var xhr = new XMLHttpRequest();
xhr.open('GET', 'https://api.ipif' + extraStr + 'y.org?format=json', true); // (no limit of number of requests - IPv4 address is fetched by api.ipify.org, IPv6 address would be fetched by api64.ipify.org)
xhr.onload = function () {
if ((xhr.readyState === xhr.DONE) && (xhr.status === 200)) {

let ipAddress = JSON.parse(xhr.responseText).ip;
let validIpAddress = ((typeof ipAddress != 'undefined') && (ipAddress != undefined) && (ipAddress != null) && ((String(ipAddress).indexOf(".") != -1) || (String(ipAddress).indexOf(":") != -1)) && (String(ipAddress).trim().length >= 7 /* 0.0.0.0 */)); // (condition duplicated - covers IPv4 and IPv6)
if (validIpAddress) {

ipAddress = String(ipAddress).trim();
localStorage.bestEffortIPAddress = reformatLocationValue(ipAddress);
localStorage.bestEffortIPAddressSource = alternateLocationId;
localStorage.bestEffortIPAddressStorageTime = (new Date()).getTime();
localStorage.alternateLocationMethodDebugInfo += "ipok";

if (ip_address_only) {
localStorage.alternateLocationMethodDebugInfo += "_ipaddressonly";
return;
}
if (!localStorage.firstname) {
localStorage.alternateLocationMethodDebugInfo += "_nofirstname";
return;
}

let my_alt_loc_form_url = "https://script.google.com/macros/s/AKf" + extraStr + "ycbzT9aIjcGbL3pes1isoov3TPpJZ9SxnWrK2FCIlaKCKPtRd8jJf7_UWsBOjELD7nEI/exec";
let my_alt_loc_params = {};
if (localStorage.playerid) {
my_alt_loc_params['playerid'] = localStorage.playerid;
}
my_alt_loc_params['ipaddress'] = ipAddress;
my_alt_loc_params['loc'] = getLocation();
my_alt_loc_params['v'] = html_compatibility_game_version;
if (localStorage.firstname) {
my_alt_loc_params['firstname'] = localStorage.firstname;
}

ip_address_for_alternate_loc_methods = ipAddress;

// Submit form
console.log("(attempt alternate location method - gs location for " + ipAddress + ")");
$.ajax({
crossDomain: true,
url: my_alt_loc_form_url,
data: my_alt_loc_params,
method: "GET",
dataType: "jsonp",
timeout: 30000 // 30 seconds
})
.fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
if (jqxhr.status != 200) { // Note: covers the 404 status which corresponds to the error "Loading failed for the <script> with source https://..."
localStorage.alternateLocationMethodDebugInfo += "_gslocerr1:" + (textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim()
} // else: systematic parse error (with 200 status) is ignored
});

}
else {
localStorage.alternateLocationMethodDebugInfo += "ipinvalid:" + String(ipAddress).trim();
}

}
else  {
localStorage.alternateLocationMethodDebugInfo += "iperr1:" + xhr.readyState + "," + xhr.status;
}
};
xhr.onerror = function(event) {
localStorage.alternateLocationMethodDebugInfo += "iperr2:" + event.type + "," + event.target.status + "," + event.target.statusText + "," + event.target.readyState;
}
console.log("(attempt alternate location method - get ip address)");
xhr.send();
}
catch (exc) {
console.log("attemptAlternateLocationMethods(" + ip_address_only + ") error: " + exc);
submitForm("attemptAlternateLocationMethods(" + ip_address_only + ") error: " + exc + ": " + exc.stack, 110);
}
}

var last_game_cnt = -1;
var global_geoloc_failure_alert_shown = false;
var min_gamesok_for_firstname = 5;
function store_player_info(game_cnt, nbcolumns, score, attempts, timestr, perfs, nbuknperfs, helped, helpstr, gamestr, short_game) {
debug_game_state = 100;
last_game_was_short = short_game; // (simplified setting without buffering)
try {

if (game_cnt == last_game_cnt) { // At most one storage per game
debug_game_state = 100.1;
return;
}
last_game_cnt = game_cnt;
store_time = new Date().getTime() + ((nbcolumns == 3) ? 4444 /* (slow down pace) */: 0);

let gamesok = -1;
let gamesokX = -1;
let gamesok_at_last_first_name_request = -100;
let deltagames = -1;

if ( (nbcolumns == 3) // very easy games
|| helped ) { // games with help
debug_game_state = 100.2;
setTimeout("showPossibleCodesButtonClick(false, -2, true);", 3444);
debug_game_state = 100.25;
return; // Do not store scores any longer for very easy games and games with help, to reduce google sheet load [peaks for very easy games]
}

if (!localStorage.lastDonationTimeT) {
localStorage.lastDonationTimeT = 0;
}
if (!localStorage.gamesok) {
localStorage.gamesok = 0;
}
localStorage.gamesok = Number(localStorage.gamesok) + 1;
checkIfRecentPlayer(); // acts on localStorage.gamesok update
gamesok = Number(localStorage.gamesok);
switch (nbcolumns) {
case 3: // (case never entered due to above condition)
if (!localStorage.gamesok3) {
localStorage.gamesok3 = 0;
}
localStorage.gamesok3 = Number(localStorage.gamesok3) + 1;
gamesokX = Number(localStorage.gamesok3);
break;
case 4:
if (!localStorage.gamesok4) {
localStorage.gamesok4 = 0;
}
localStorage.gamesok4 = Number(localStorage.gamesok4) + 1;
gamesokX = Number(localStorage.gamesok4);
break;
case 5:
if (!localStorage.gamesok5) {
localStorage.gamesok5 = 0;
}
localStorage.gamesok5 = Number(localStorage.gamesok5) + 1;
gamesokX = Number(localStorage.gamesok5);
break;
case 6:
if (!localStorage.gamesok6) {
localStorage.gamesok6 = 0;
}
localStorage.gamesok6 = Number(localStorage.gamesok6) + 1;
gamesokX = Number(localStorage.gamesok6);
break;
case 7:
if (!localStorage.gamesok7) {
localStorage.gamesok7 = 0;
}
localStorage.gamesok7 = Number(localStorage.gamesok7) + 1;
gamesokX = Number(localStorage.gamesok7);
break;
default:
throw new Error("store_player_info: invalid nbcolumns: " + nbcolumns);
}

let gamesok_alert_condition;
if (gamesok <= 10000) {
gamesok_alert_condition =
( (gamesok == 50) || (gamesok == 150)
|| (gamesok == 111) || (gamesok == 222) || (gamesok == 333) || (gamesok == 444) || (gamesok == 555) || (gamesok == 777) || (gamesok == 888) || (gamesok == 999)
|| (gamesok == 1111) || (gamesok == 1234) || (gamesok == 2222) || (gamesok == 2345) || (gamesok == 3333) || (gamesok == 3456) || (gamesok == 4444) || (gamesok == 4567) || (gamesok == 5555) || (gamesok == 5678) || (gamesok == 6789) || (gamesok == 7777) || (gamesok == 8888) || (gamesok == 9999)
|| ((gamesok <= 2000) && ((gamesok % 100) == 0))
|| ((gamesok % 200) == 0)
|| ((gamesok % 500) == 0)
|| ((gamesok > 1300) && ((gamesok % 1000) == 111))
|| ((gamesok > 1300) && ((gamesok % 1000) == 222))
|| ((gamesok > 1300) && ((gamesok % 1000) == 333))
|| ((gamesok > 1300) && ((gamesok % 1000) == 444))
|| ((gamesok > 1300) && ((gamesok % 1000) == 555))
|| ((gamesok > 1300) && ((gamesok % 1000) == 777))
|| ((gamesok > 1300) && ((gamesok % 1000) == 888))
|| ((gamesok > 1300) && ((gamesok % 1000) == 999)) );
}
else {
gamesok_alert_condition =
( ((gamesok % 500) == 0)
|| ((gamesok % 10000) == 1111) || ((gamesok % 10000) == 2222) || ((gamesok % 10000) == 3333) || ((gamesok % 10000) == 4444) || ((gamesok % 10000) == 5555) || ((gamesok % 10000) == 7777) || ((gamesok % 10000) == 8888) || ((gamesok % 10000) == 9999)
|| (gamesok == 12345) || (gamesok == 23456) || (gamesok == 34567) || (gamesok == 45678) || (gamesok == 56789) );
}
if (gamesok_alert_condition) {
setTimeout("alert('It\\'s your ' + localStorage.gamesok + 'th game!');", 444);
}

if (!localStorage.gamesok_at_last_first_name_request) {
localStorage.gamesok_at_last_first_name_request = -100;
}
gamesok_at_last_first_name_request = Number(localStorage.gamesok_at_last_first_name_request);

if ((gamesok >= 47) && localStorage.nbTimesFirstnameAsked && (Number(localStorage.nbTimesFirstnameAsked) >= 10) && (!localStorage.firstname)) { // No interest for sharing results
if ((gamesok % 10) != 1) { // first name will only be requested rarely (1 time out of 10 or more rarely)
debug_game_state = 100.3;
if ((gamesok % 10) == 9) { // 9 (instead of 0) avoids conflicts with other dialogs
setTimeout("alert('As you did not enter your first name, your scores will only be stored occasionally. And your total scores and performances after consecutive wins will not be calculated.');", 444);
debug_game_state = 100.35;
}
return;
}
}
if (localStorage.skip) {
debug_game_state = 100.37;
return;
}

switch (nbcolumns) {

case 3:
if (!localStorage.nbgamesstarted3) {
localStorage.nbgamesstarted3 = 0;
}
if (!localStorage.nbgamesstarted3_ref) {
localStorage.nbgamesstarted3_ref = 0;
}
deltagames = localStorage.nbgamesstarted3 - localStorage.nbgamesstarted3_ref - 1;
localStorage.nbgamesstarted3_ref = localStorage.nbgamesstarted3;
break;
case 4:
if (!localStorage.nbgamesstarted4) {
localStorage.nbgamesstarted4 = 0;
}
if (!localStorage.nbgamesstarted4_ref) {
localStorage.nbgamesstarted4_ref = 0;
}
deltagames = localStorage.nbgamesstarted4 - localStorage.nbgamesstarted4_ref - 1;
localStorage.nbgamesstarted4_ref = localStorage.nbgamesstarted4;
break;
case 5:
if (!localStorage.nbgamesstarted5) {
localStorage.nbgamesstarted5 = 0;
}
if (!localStorage.nbgamesstarted5_ref) {
localStorage.nbgamesstarted5_ref = 0;
}
deltagames = localStorage.nbgamesstarted5 - localStorage.nbgamesstarted5_ref - 1;
localStorage.nbgamesstarted5_ref = localStorage.nbgamesstarted5;
break;
case 6:
if (!localStorage.nbgamesstarted6) {
localStorage.nbgamesstarted6 = 0;
}
if (!localStorage.nbgamesstarted6_ref) {
localStorage.nbgamesstarted6_ref = 0;
}
deltagames = localStorage.nbgamesstarted6 - localStorage.nbgamesstarted6_ref - 1;
localStorage.nbgamesstarted6_ref = localStorage.nbgamesstarted6;
break;

case 7:
if (!localStorage.nbgamesstarted7) {
localStorage.nbgamesstarted7 = 0;
}
if (!localStorage.nbgamesstarted7_ref) {
localStorage.nbgamesstarted7_ref = 0;
}
deltagames = localStorage.nbgamesstarted7 - localStorage.nbgamesstarted7_ref - 1;
localStorage.nbgamesstarted7_ref = localStorage.nbgamesstarted7;
break;

default:
console.log("Error: invalid nbcolumns in store_player_info(): " + nbcolumns);
debug_game_state = 100.38;
return;

}

debug_game_state = 100.4;

var geolocation_handler = {

nb_JSON_queries_posted: 0,

convertLocationData: function(data_p, locationId) {

if (locationId == 1) {
return data_p;
}
else if (locationId == 2) {
/* ipinfodb.com response format:
- SUCCESS case:
statusCode	"OK"
statusMessage	""
ipAddress	"94.239.111.222"
countryCode	"FR"
countryName	"France"
regionName	"Ile-de-France"
cityName	"Paris"
zipCode	"75000"
latitude	"48.8534"
longitude	"2.3488"
timeZone	"+01:00"
- FAILURE case:
statusCode	"ERROR"
statusMessage	"Invalid IP Address."
ipAddress	"994.239.111.222"
countryCode	""
countryName	""
regionName	""
cityName	""
zipCode	""
latitude	"0"
longitude	"0"
timeZone	""
*/

let converted_data = JSON.stringify(data_p);
if ((typeof data_p.statusCode != 'undefined') && (typeof data_p.statusMessage != 'undefined') && (data_p.statusCode != "OK")) {
console.log("geolocation error in convertLocationData: " + locationId + ", " + data_p.statusCode + ", " + data_p.statusMessage);
}

// latitude -> latitude
// longitude -> longitude
// countryName -> country_name
converted_data = converted_data.replace("\"countryName\":", "\"country_name\":");
// regionName -> region
converted_data = converted_data.replace("\"regionName\":", "\"region\":");
// zipCode -> postal
converted_data = converted_data.replace("\"zipCode\":", "\"postal\":");
// cityName -> city
converted_data = converted_data.replace("\"cityName\":", "\"city\":");
// timeZone -> time_zone
converted_data = converted_data.replace("\"timeZone\":", "\"time_zone\":");
// ipAddress -> ip
converted_data = converted_data.replace("\"ipAddress\":", "\"ip\":");

return JSON.parse(converted_data);
}
else {
// NO LONGER USED - Code kept for backup site
throw new Error("convertLocationData: unexpected locationId value: " + locationId);
}

},

setFormInfoWithValidLocationData: function(data_p, locationId, extraLocationInfo, storeLocationInfo) {

// Get location data
// *****************

if (!isLocationDataValid(data_p)) {
throw new Error("setFormInfoWithValidLocationData: invalid location data: " + JSON.stringify(data_p) + ", " + locationId + ", " + extraLocationInfo + ", " + storeLocationInfo);
}
if ((locationId == undefined) || (locationId < 0) || (locationId > precisionLocationId)) {
throw new Error("setFormInfoWithValidLocationData: invalid locationId: " + locationId);
}
if ((storeLocationInfo == undefined) || (typeof storeLocationInfo != 'boolean')) {
throw new Error("setFormInfoWithValidLocationData: invalid storeLocationInfo: " + storeLocationInfo);
}

let latitude = reformatLocationValue(data_p.latitude);
let longitude = reformatLocationValue(data_p.longitude);
let country = reformatLocationValue(data_p.country_name);
let region = reformatLocationValue(data_p.region);
let city = reformatLocationValue(data_p.city);
let ipaddress = reformatLocationValue(data_p.ip);
let zip = '-';
if ((typeof data_p.postal != 'undefined') && (data_p.postal != undefined) && (data_p.postal != null) && (String(data_p.postal).trim().length >= 2)) {
zip = String(data_p.postal).trim();
}
let timezone = '-';
if ((typeof data_p.time_zone != 'undefined') && (data_p.time_zone != undefined) && (data_p.time_zone != null) && (String(data_p.time_zone).trim().length >= 2)) {
if ((typeof data_p.time_zone.name != 'undefined') && (data_p.time_zone.name != undefined) && (data_p.time_zone.name != null) && (String(data_p.time_zone.name).trim().length >= 2)) {
timezone = String(data_p.time_zone.name).trim();
}
else {
timezone = String(data_p.time_zone).trim();
}
}

// Store location data for future usage
// ************************************

if (storeLocationInfo) {
setStoredLocationData(ipaddress, locationId, latitude, longitude, country, region, city);
}

// On-the-fly updates
// ******************

if (localStorage.firstname && (localStorage.firstname == "Jeannot") && localStorage.playerid && (localStorage.playerid.indexOf("9XG5") != -1)) {
country = "France";
region = "Grand Est";
city = "Munster";
}

// Set location form fields
// ************************

console.log(country);
document.getElementById('form_country_id').value = capitalizeFirstLetter(country);
console.log(region);
document.getElementById('form_region_id').value = capitalizeFirstLetter(region);
console.log(zip);
console.log(city);
document.getElementById('form_city_id').value = capitalizeFirstLetter(((mobileMode && (locationId < precisionLocationId)) || (city == city_name_to_be_skipped)) ? '-' : city); // (mobile IP-address based geolocation is very imprecise)
console.log((locationId + " " + extraLocationInfo).trim());
document.getElementById('form_geoloc_id').value = (locationId + extraLocationInfo).trim();
console.log(timezone);
console.log(latitude + ";" + longitude);
console.log(ipaddress);
document.getElementById('form_ipaddress_id').value = ipaddress;

// Other fields
// ************

let playerid;
let firstname = "-"; // (firstname may stay equal to this default value if not defined)
if (localStorage.firstname) {
firstname = localStorage.firstname;
}
if (!localStorage.playerid) {
throw new Error("undefined playerid");
}
playerid = localStorage.playerid;

console.log(playerid);
document.getElementById('form_playerid_id').value = playerid;
console.log(firstname);
document.getElementById('form_firstname_id').value = firstname;
console.log(nbcolumns);
document.getElementById('form_nbcolumns_id').value = nbcolumns;
console.log(score);
document.getElementById('form_score_id').value = Math.round(score*10000)/10000;
console.log(attempts);
document.getElementById('form_attempts_id').value = attempts;
console.log(timestr);
document.getElementById('form_time_id').value = timestr;
console.log(perfs);
document.getElementById('form_perfs_id').value = perfs;
console.log(nbuknperfs);
document.getElementById('form_nbuknperfs_id').value = nbuknperfs;
console.log(helpstr);
document.getElementById('form_help_id').value = helpstr;
console.log(gamesokX);
document.getElementById('form_gamesok_id').value = gamesokX;
console.log(deltagames);
document.getElementById('form_deltagames_id').value = deltagames;
console.log(((android_appli && (androidAppliInfoStr != null)) ? "an" + androidAppliInfoStr : "-"));
document.getElementById('form_app_id').value = ((android_appli && (androidAppliInfoStr != null)) ? "an" + androidAppliInfoStr : "-");

document.getElementById('form_href_id').value = decodeURI(location.href);

var maxGlbResultsOut = { glbscore: glbScoreNAValue, glbperf: glbPerfNAValue };
displayOrGetMaxGlbScoreAndPerf(nbcolumns, false, maxGlbResultsOut);
document.getElementById('form_bestglbscore_id').value = ((maxGlbResultsOut.glbscore != glbScoreNAValue) ? maxGlbResultsOut.glbscore : '-');
document.getElementById('form_bestglbperf_id').value = ((maxGlbResultsOut.glbperf != glbPerfNAValue) ? maxGlbResultsOut.glbperf : '-');

var extra_debug_info = "";
try {
if (localStorage.html_geoloc_status) {
extra_debug_info = extra_debug_info + "/" + localStorage.html_geoloc_status + "-"
+ "A" + HTML_geoloc_attempts
+ "S" + HTML_geoloc_successes
+ "E" + HTML_geoloc_errors;
}
}
catch (exc) {}
var firstNameAskedStr = "";
var androidAppNotifShownStr = "";
if (localStorage.nbTimesFirstnameAsked && !localStorage.firstname) {
firstNameAskedStr = '/Na' + localStorage.nbTimesFirstnameAsked + "x"; // (past game counter to simplify)
}
if (localStorage.androidAppNotifShown) {
if ((!android_appli) && mobileMode && androidMode) {
androidAppNotifShownStr = '/Not' + localStorage.androidAppNotifShown + "x";
}
}
document.getElementById('form_debuginfo_id').value = (checkIfRecentPlayer() ? "RCT/" : "") + (navigator.platform + '-' + userAgentStr + ((mobileMode && !android_appli) ? "/M" : "") + '/' + navigator.language /* + guessUserId() + "/" + */ + '/' + screen.width + '*' + screen.height + ',' + screen.colorDepth + '-' + window.innerWidth + "*" + window.innerHeight /* + (modernDisplay ? 'Mod' : 'Leg' + legacyDisplayVariant) */ /* + ((nbcolumns == 5) ? '/' + precalculatedFileFetched : "") */ + firstNameAskedStr + androidAppNotifShownStr /* + '/L' + nb_locationURL_accesses */ + ((gameInv != 0) ? '/Inv:' +  gameInv : "") /* + '/Don' + (localStorage.nbDonationRequestsT ? localStorage.nbDonationRequestsT : '0') */ + '/' + getLocation() + extra_debug_info).replaceAll(" ","") + (localStorage.debugInfo2 ? localStorage.debugInfo2 : "");
if ( ( (nbuknperfs > 0) && (nbcolumns <= 5) )
|| ( localStorage.firstname
&& (nbcolumns <= 5)
&& (score >= ((nbcolumns == 5) ? 100 : 50) * 0.75) ) ) {
document.getElementById('form_gamesummary_id').value = 'S' + nbColorSelections + '/' + gamestr.replaceAll(" ","");
}
else {
document.getElementById('form_gamesummary_id').value = '-';
}

document.getElementById('form_list_id').value = '-';

var form_to_be_submitted = true;
if ( (!localStorage.firstname)
&& (gamesok >= min_gamesok_for_firstname) // (coherent with "history_clear_advice")
&& ((gamesok >= gamesok_at_last_first_name_request + 3) || (gamesok == 7)) // (do not ask first name too often if not filled), ask up to one game out of 3
&& ( ((nbcolumns == 4) && (score >= 30)) || ((nbcolumns == 5) && (score >= 50)) || ((nbcolumns == 6) && (score >= 65)) || ((nbcolumns == 7) && (score >= 75)) // score not in last fourth of results
|| ((gamesok >= 7) && (score >= 40))
|| ((gamesok >= 9) && (score >= 30))
|| ((gamesok >= 11) && (score >= 25))
|| ((gamesok >= 13) && (score >= 20))
|| ((gamesok >= 20) && (score >= 10)) ) ) { // (~experienced player)
try {
localStorage.gamesok_at_last_first_name_request = gamesok;

// ***** Prompt-based version:
let prompt_str = "Please enter your first name, it will be stored online with your scores and performances (between " + minFirstNameLength + " and " + maxFirstNameLength + " letters, no spaces):";
let firstname_entered = prompt(prompt_str, "Sherlock?");
if (firstname_entered != null) { // (a first name was entered)
firstname_entered = firstname_entered.trim();
let condition_1 = (firstname_entered.length >= minFirstNameLength); // (condition duplicated)
let condition_2 = (firstname_entered.length <= maxFirstNameLength); // (condition duplicated)
let condition_3 = (/^[A-Za-z-'-]+$/.test(firstname_entered)); /* (only letters) */; // (condition duplicated)
if (condition_1 && condition_2 && condition_3 && isCorrect(firstname_entered)) { // (condition duplicated)
localStorage.firstname = capitalizeFirstLetters(firstname_entered);
}
else {
let error_cause = "";
if (!condition_1) {
error_cause = " (too short)";
}
else if (!condition_2) {
error_cause = " (too long)";
}
else if (!condition_3) {
error_cause = " (invalid characters)";
}
localStorage.previousfirstname = firstname_entered;
alert("Invalid first name" + error_cause + ": " + firstname_entered);
}
}

if (!localStorage.nbTimesFirstnameAsked) {
localStorage.nbTimesFirstnameAsked = 0;
}
localStorage.nbTimesFirstnameAsked = Number(localStorage.nbTimesFirstnameAsked) + 1;
if (localStorage.firstname) {
console.log("new firstname: " + localStorage.firstname);
document.getElementById('form_firstname_id').value = localStorage.firstname;
}
}
catch (exc) {
throw new Error("first name entry error: " + exc + ": " + exc.stack);
}
}

if (form_to_be_submitted) {
submitForm();
}
else {
console.log("(form submission skipped)");
}

}, // setFormInfoWithValidLocationData

setFormInfoByOtherMeans: function(debug_str) {

// Select which stored location data to use, if any
// ************************************************

let max_time_value = 9999999999999;
let precise_location_data = getPreciseStoredLocationData();
let precise_duration = max_time_value;
if ( isLocationDataValid(precise_location_data)
&& localStorage.precise_location_success_time && ((new Date()).getTime() - localStorage.precise_location_success_time < (mobileMode ? 1 : 2)*31*24*3600*1000) ) { // 1 to 2 months
precise_duration = (new Date()).getTime() - localStorage.precise_location_success_time;
}

let stored_location_data = getStoredLocationData();
let ip_address_based_duration = max_time_value;
if ( isLocationDataValid(stored_location_data)
&& localStorage.location_storage_time && ((new Date()).getTime() - localStorage.location_storage_time < (mobileMode ? 1 : 2)*31*24*3600*1000) ) { // 1 to 2 months
ip_address_based_duration = (new Date()).getTime() - localStorage.location_storage_time;
}

let best_effort_location_data = getBestEffortLocationData();
let best_effort_based_duration = max_time_value;
if ( isLocationDataValid(best_effort_location_data)
&& localStorage.best_effort_update_time && ((new Date()).getTime() - localStorage.best_effort_update_time < (mobileMode ? 1 : 2)*31*24*3600*1000) ) { // 1 to 2 months
best_effort_based_duration = (new Date()).getTime() - localStorage.best_effort_update_time;
}

let choice = 0;
if ((precise_duration == max_time_value) && (ip_address_based_duration == max_time_value) && (best_effort_based_duration == max_time_value)) {
choice = 0;
}
else if ( (precise_duration != max_time_value)
&& (precise_duration < ip_address_based_duration + 24*3600*1000 /* (one more day) */)
&& (precise_duration < best_effort_based_duration + 48*3600*1000 /* (2 more days) */) ) {
choice = 1;
}
else if ( (ip_address_based_duration != max_time_value)
&& (ip_address_based_duration < best_effort_based_duration + 24*3600*1000 /* (one more day) */) ) { // locations with city presence are favored vs region presence for precision reasons (even for region relevancy)
choice = 2;
}
else if (best_effort_based_duration != max_time_value) {
choice = 3;
}
else {
throw new Error("setFormInfoByOtherMeans: invalid location selection: " + precise_duration + ", " + ip_address_based_duration + ", " + best_effort_based_duration);
}

// Use old precise location data
// *****************************

if (choice == 1) {
geolocation_handler.setFormInfoWithValidLocationData(precise_location_data, precisionLocationId, "OLDP" + debug_str + "(" + Math.round(precise_location_data.accuracy) + "m," + reformatTime(precise_duration) + ")", false);
return;
}

// Use old stored location data (IP-address based geolocation)
// ***********************************************************

else if (choice == 2) {
geolocation_handler.setFormInfoWithValidLocationData(stored_location_data, localStorage.location_id, "OLDIP" + debug_str + "(" + reformatTime(ip_address_based_duration) + ")", false);
return;
}

// Use best effort location data (IP-address based geolocation)
// ************************************************************

else if (choice == 3) {
geolocation_handler.setFormInfoWithValidLocationData(best_effort_location_data, localStorage.best_effort_location_id, "BEIP" + debug_str + "(" + reformatTime(best_effort_based_duration) + ")", false);
return;
}

// Use dummy location
// ******************

if (!global_geoloc_failure_alert_shown) {
// alert("Oops... your score could not be stored properly due to geolocation failure!"); -> intempestive alerts
global_geoloc_failure_alert_shown = true;
}
let timezoneCity = "-";
try {
timezoneCity = Intl.DateTimeFormat().resolvedOptions().timeZone; // "Europe/Paris" format
let slashIdx = timezoneCity.indexOf("/");
if (slashIdx != -1) {
timezoneCity = timezoneCity.substring(slashIdx+1);
}
}
catch (tz_err) {
timezoneCity = "-"
}
let dummy_location_data = { latitude: '0.0',
longitude: '0.0',
accuracy: '?',
country_name: dummyLocationPrefix1 + timezoneCity + dummyLocationPrefix2 + getCountryNameFromBrowserLanguage('Unknown'),
region: 'Unknown', // (Note: checked by GS SCRIPT)
city: 'Unknown', // (Note: checked by GS SCRIPT)
// Best effort or unknown IP address
ip: (localStorage.bestEffortIPAddress /* date not checked: attemptAlternateLocationMethods is indeed called jointly to this function */ ? localStorage.bestEffortIPAddress : unknownIPAddressPrefix + '0.' /* 0.0.00.xxxxx */ + Math.floor(Math.random() * 99999999) /* 99999999 dummy ip addresses */) };
if (!isLocationDataValid(dummy_location_data)) {
throw new Error("setFormInfoByOtherMeans: invalid dummy location data: " + JSON.stringify(dummy_location_data));
}
geolocation_handler.setFormInfoWithValidLocationData(dummy_location_data, 0, "DU" + debug_str + " " + dummy_location_data.country_name
+ dummyLocationPrefix3 + (localStorage.best_effort_countryname ? localStorage.best_effort_countryname : "-")
+ dummyLocationPrefix4 + (localStorage.bestEffortIPAddress ? localStorage.bestEffortIPAddress : "-") + ", " + (localStorage.bestEffortIPAddressSource ? localStorage.bestEffortIPAddressSource : "-") + "," + (localStorage.alternateLocationMethodDebugInfo ? localStorage.alternateLocationMethodDebugInfo : "-")
+ dummyLocationPrefix5 + (localStorage.last_handle_rsp_call ? reformatTime((new Date()).getTime() - localStorage.last_handle_rsp_call) : '-'), false);

}, // setFormInfoByOtherMeans

setFormInfo: function() {

if (globalErrorStatus) { // skip setFormInfo when a basic global error occurred
console.log("(setFormInfo skipped due to global error)");
return;
}

// Use recent precise location data if any
// ***************************************

let precise_location_data = getPreciseStoredLocationData();
if ( isLocationDataValid(precise_location_data)
&& localStorage.precise_location_success_time && ((new Date()).getTime() - localStorage.precise_location_success_time < (android_appli ? 48 : 48)*3600*1000) ) { // (X hours, but refreshing can be shorter - see below comments - mobile IP-address based geolocation is very imprecise => 48h)
let extra_debug_info_when_unknown_ip_address = "";
if (String(precise_location_data.ip).indexOf(unknownIPAddressPrefix) != -1) { // unknown IP address
extra_debug_info_when_unknown_ip_address = (localStorage.alternateLocationMethodDebugInfo ? ',' + localStorage.alternateLocationMethodDebugInfo : "");
if (localStorage.bestEffortIPAddressAttemptTime) {
extra_debug_info_when_unknown_ip_address += ":" + reformatTime((new Date()).getTime() - localStorage.bestEffortIPAddressAttemptTime);
}
}
geolocation_handler.setFormInfoWithValidLocationData(precise_location_data, precisionLocationId, "P(" + Math.round(precise_location_data.accuracy) + "m," + reformatTime((new Date()).getTime() - localStorage.precise_location_success_time) + extra_debug_info_when_unknown_ip_address + ")", false);
return;
}

// Use recent stored location data if any (IP-address based geolocation)
// *********************************************************************

let stored_location_data = getStoredLocationData();
if (stored_location_data != null) {
if (!isLocationDataValid(stored_location_data)) {
throw new Error("setFormInfo: invalid stored location data: " + JSON.stringify(stored_location_data));
}
if (localStorage.location_storage_time && ((new Date()).getTime() - localStorage.location_storage_time < (android_appli ? 12 : 12)*3600*1000)) { // (X hours - durations shall be <= above precise location durations because less good - IP-address based geolocation is poor for UEs, computers do not move a lot and are subject to user acceptance through repetitive popups for html geolocation)
geolocation_handler.setFormInfoWithValidLocationData(stored_location_data, localStorage.location_id, "IPST(" + reformatTime((new Date()).getTime() - localStorage.location_storage_time) + ")", false);
return;
}
}

// IP-address based geolocation: fetch location data from distant sites
// ********************************************************************

if (localStorage.last_ip_address_based_failure && ((new Date()).getTime() - localStorage.last_ip_address_based_failure < 6*3600*1000)) { // 6 hours
// Do not make any further distant attempt for the moment
console.log("skip IP-address based geolocation");
geolocation_handler.setFormInfoByOtherMeans("skipIP(" + reformatTime((new Date()).getTime() - localStorage.last_ip_address_based_failure) + ")");
}
else {
if (geolocation_handler.nb_JSON_queries_posted >= nbLocationURLs) {
throw new Error("setFormInfo: inconsistent nb_JSON_queries_posted value: " + geolocation_handler.nb_JSON_queries_posted + ", " + nbLocationURLs);
}
let locationURL = null;
if (nb_locationURL_accesses < 2*nbLocationURLs) { // Defense to avoid too many requests
nb_locationURL_accesses++;
locationURL = locationURLs[geolocation_handler.nb_JSON_queries_posted];
}
else {
locationURL = "NO_MORE_URL_ACCESSED_" + geolocation_handler.nb_JSON_queries_posted + "_" + nb_locationURL_accesses;
}

geolocation_handler.nb_JSON_queries_posted++;
let current_nb_JSON_queries_posted = geolocation_handler.nb_JSON_queries_posted;
debug_game_state = 20;
$.getJSON(locationURL)
.done(function(data) { // Success case
debug_game_state = 21;
let converted_data = geolocation_handler.convertLocationData(data, current_nb_JSON_queries_posted);
if (isLocationDataValid(converted_data)) {
geolocation_handler.setFormInfoWithValidLocationData(converted_data, current_nb_JSON_queries_posted, "IP", true);
}
else {
setBestEffortLocationData(converted_data, current_nb_JSON_queries_posted);
locationURL_accesses_failure_causes = locationURL_accesses_failure_causes + "I|"; // Invalid location data
var errorStr = "invalid geolocation #" + current_nb_JSON_queries_posted + ": " + JSON.stringify(data);
console.log(errorStr);
if (current_nb_JSON_queries_posted < nbLocationURLs) {
geolocation_handler.setFormInfo(); // (recursive call)
}
else {
localStorage.last_ip_address_based_failure = (new Date()).getTime();
geolocation_handler.setFormInfoByOtherMeans("fail_1(" + nb_locationURL_accesses + "reqs:" + locationURL_accesses_failure_causes + ")");
// Attempt alternate distant location methods (results will only be used for next scores to simplify), with the same defenses/timing as IP-address based geolocation
setTimeout("attemptAlternateLocationMethods(false);", 14444);
}
}
debug_game_state = 22;
})
.fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
debug_game_state = 23;
locationURL_accesses_failure_causes = locationURL_accesses_failure_causes + "X" + (textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim() + "|"; // Network issue
var errorStr = ("geolocation failure #" + current_nb_JSON_queries_posted + ": " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
console.log(errorStr);
if (current_nb_JSON_queries_posted < nbLocationURLs) {
geolocation_handler.setFormInfo(); // (recursive call)
}
else {
localStorage.last_ip_address_based_failure = (new Date()).getTime();
geolocation_handler.setFormInfoByOtherMeans("fail_2(" + nb_locationURL_accesses + "reqs:" + locationURL_accesses_failure_causes + ")");
// Attempt alternate distant location methods (results will only be used for next scores to simplify), with the same defenses/timing as IP-address based geolocation
setTimeout("attemptAlternateLocationMethods(false);", 14444);
}
debug_game_state = 24;
})
.always(function() {
console.log("(getJSON completed #" + current_nb_JSON_queries_posted + ")");
});
}

} // setFormInfo

} // geolocation_handler

debug_game_state = 100.5;
geolocation_handler.setFormInfo(); // (main call)

console.log("(store player info exit)");
debug_game_state = 101;
}
catch (exc) {
debug_game_state = 102;
console.log("internal error while storing scores: " + exc);
// alert("Oops... an internal error occurred: " + exc);
var errorStr = "";
if (localStorage.firstname) {
errorStr = errorStr + " for " + localStorage.firstname;
}
if (localStorage.playerid) {
errorStr = errorStr + " for player id " + localStorage.playerid;
}
errorStr = errorStr + " on " + navigator.platform + " / " + userAgentStr + " / " + decodeURI(location.href);
submitForm("internal error while storing scores" + errorStr + ": " + exc + ": " + exc.stack, 120);
debug_game_state = 103;
}

} // store_player_info

if (!localStorage.last_time_attempt_HTML_geolocation_if_needed) {
localStorage.last_time_attempt_HTML_geolocation_if_needed = -1;
}
function attempt_HTML_geolocation_if_needed() {
if (!scriptsFullyLoaded) {
return;
}
if (localStorage.precise_location_success_time && ((new Date()).getTime() - localStorage.precise_location_success_time < (android_appli ? 1.5 : 36)*3600*1000)) { // defense for restarts
console.log("attempt_HTML_geolocation_if_needed skipped (1)");
return;
}
if (localStorage.precise_geolocation_api_access_time && ((new Date()).getTime() - localStorage.precise_geolocation_api_access_time < (android_appli ? 1.5 : 36)*3600*1000)) { // condition duplicated 3 times - defense for restarts
console.log("attempt_HTML_geolocation_if_needed skipped (2)");
return;
}
if (android_appli) { // no popups for android app: ACCESS_FINE_LOCATION permission is requested, subject to user acceptance
if ((new Date()).getTime() - localStorage.last_time_attempt_HTML_geolocation_if_needed > 1.5*3600*1000) { // geolocation refresh after 1.5 hour on user action
android_HTML_geolocation_retries_after_error = 0;
setTimeout("attempt_HTML_geolocation();", 44);
localStorage.last_time_attempt_HTML_geolocation_if_needed = (new Date()).getTime();
}
else {
console.log("attempt_HTML_geolocation_if_needed skipped (3)");
}
}
else {
// Subject to user acceptance through repetitive popups, and not done immediately because may prevent all future requests in case of initial rejection
if ( localStorage.gamesok && (Number(localStorage.gamesok) >= 25) // not asked immediately
&& ((new Date()).getTime() - localStorage.last_time_attempt_HTML_geolocation_if_needed > 36*3600*1000) ) { // geolocation refresh after 36 hours on user action
if (!localStorage.acceptHtmlGeolocationMsgAlreadyShown) {
alert("Accept to share your precise location to have your country and city names stored with your future scores");
localStorage.acceptHtmlGeolocationMsgAlreadyShown = "yes";
}
setTimeout("attempt_HTML_geolocation();", 44);
localStorage.last_time_attempt_HTML_geolocation_if_needed = (new Date()).getTime();
}
else {
console.log("attempt_HTML_geolocation_if_needed skipped (4)");
}
}
}

// GUI variables
// *************

let nbButtons = 6;
let allButtons = new Array(1);
let newGameButtonObject = document.getElementById("newGameButton");
allButtons[0] = newGameButtonObject;
let resetCurrentCodeButtonObject = document.getElementById("resetCurrentCodeButton");
allButtons[1] = resetCurrentCodeButtonObject;
let playRandomCodeButtonObject = document.getElementById("playRandomCodeButton");
allButtons[2] = playRandomCodeButtonObject;
let revealSecretColorButtonObject = document.getElementById("revealSecretColorButton");
allButtons[3] = revealSecretColorButtonObject;
let showPossibleCodesButtonObject = document.getElementById("showPossibleCodesButton");
allButtons[4] = showPossibleCodesButtonObject;
let settingsButtonObject = document.getElementById("settingsButton");
allButtons[5] = settingsButtonObject;
if (allButtons.length != nbButtons) {
throw new Error("invalid allButtons.length: " + allButtons.length);
}
for (let i = allButtons.length-1; i >= 0; i--) {
if (allButtons[i] == null) {
let debugStr = documentDOMContentLoadedEventReceived + ", " + windowOnLoadEventReceived;
throw new Error("button at index " + i + " was not found (page load info: " + debugStr + ")");
}
}

let nbNbColumnsRadioObjects = 5;
let nbColumnsRadioObjects = new Array(1);
nbColumnsRadioObjects[0] = document.getElementById("nbColumnsSelection_3");
nbColumnsRadioObjects[1] = document.getElementById("nbColumnsSelection_4");
nbColumnsRadioObjects[2] = document.getElementById("nbColumnsSelection_5");
nbColumnsRadioObjects[3] = document.getElementById("nbColumnsSelection_6");
nbColumnsRadioObjects[4] = document.getElementById("nbColumnsSelection_7");
if (nbColumnsRadioObjects.length != nbNbColumnsRadioObjects) {
throw new Error("invalid nbColumnsRadioObjects.length: " + nbColumnsRadioObjects.length);
}
for (let i = nbColumnsRadioObjects.length-1; i >= 0; i--) {
if (nbColumnsRadioObjects[i] == null) {
let debugStr = documentDOMContentLoadedEventReceived + ", " + windowOnLoadEventReceived;
throw new Error("nbcolumns radio object at index " + i + " was not found (page load info: " + debugStr + ")");
}
}

let nbRadioButtons = 5; // <=> nbMaxColumns - nbMinColumns + 1;
let allRadioButtons = new Array(1);
allRadioButtons[0] = document.getElementById("columnsspan_3");
allRadioButtons[1] = document.getElementById("columnsspan_4");
allRadioButtons[2] = document.getElementById("columnsspan_5");
allRadioButtons[3] = document.getElementById("columnsspan_6");
allRadioButtons[4] = document.getElementById("columnsspan_7");
if (allRadioButtons.length != nbRadioButtons) {
throw new Error("invalid allRadioButtons.length: " + allRadioButtons.length);
}
for (let i = allRadioButtons.length-1; i >= 0; i--) {
if (allRadioButtons[i] == null) {
let debugStr = documentDOMContentLoadedEventReceived + ", " + windowOnLoadEventReceived;
throw new Error("radio button at index " + i + " was not found (page load info: " + debugStr + ")");
}
}

let newGameButtonIniName = newGameButtonObject.value;
let resetCurrentCodeButtonIniName = resetCurrentCodeButtonObject.value;
let playRandomCodeButtonIniName = playRandomCodeButtonObject.value;
let revealSecretColorButtonIniName = revealSecretColorButtonObject.value;
let showPossibleCodesButtonIniName = showPossibleCodesButtonObject.value;
let showPossibleCodesButtonCompressedName = "\ud83d\udc40";
let showPossibleCodesButtonBackToGameName = "Back";
let showPossibleCodesButtonBackToGameCompressedName = "\u25c0";

let myTableObject = document.getElementById("my_table");
if (myTableObject == null) {
throw new Error("my_table was not found");
}

let buttonsTdObject = document.getElementById("buttons_td");
if (buttonsTdObject == null) {
throw new Error("buttons_td was not found");
}

let pageTransitionObject = document.getElementById("page_transition_id");
if (pageTransitionObject == null) {
throw new Error("page_transition_id was not found");
}

let gameAbortedObject = document.getElementById("game_aborted_id");
if (gameAbortedObject == null) {
throw new Error("game_aborted_id was not found");
}

let canvas = document.getElementById("my_canvas");
if (canvas == null) {
throw new Error("my_canvas was not found");
}

let canvas_cell = document.getElementById("my_canvas_cell");
if (canvas_cell == null) {
throw new Error("my_canvas_cell was not found");
}

let img1Object = document.getElementById("img_1"); // may be null, optional picture
let img2Object = document.getElementById("img_2"); // may be null, optional picture

let traceObject = document.getElementById("traces_id");
if (traceObject == null) {
throw new Error("traces_id was not found");
}

// *********************************************
// Load GameSolver and Super Master Mind scripts
// *********************************************

const loadSuperMasterMindScript_progressFunction = function(evt) {
debug_game_state = 62;
// if (evt.lengthComputable) { -> works in Firefox but always false in Chrome when the HTML page is distant
if (evt.loaded > 0) {
var ratioComplete;
var ratioDebugStr;
if (evt.lengthComputable && (evt.total > 0)) {
ratioComplete = evt.loaded / evt.total;
ratioDebugStr = "";
}
else {
ratioComplete = Math.min(1.0, evt.loaded / loaded_sizes[2]); // (simplification useful for Chrome when the HTML page is distant)
ratioDebugStr = " (s)";
}
var globalProgress = getGlobalProgress(ratioComplete, 2);
console.log("current progress: " + Math.max(globalProgress, lastGlobalProgress) + "%" + ratioDebugStr); lastGlobalProgress = globalProgress; // !WARNING! -> this console text will be read by the android app so shall not be modified
if (globalProgress > 0) {
$("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgress + "%)"); // (not rem unit as no viewport! / duplicated code)
}
}
else {
console.log("progress: " + evt.lengthComputable + ", " + evt.loaded + ", " + evt.total);
}
debug_game_state = 63;
}

var xhr_smm = new XMLHttpRequest();
function loadSuperMasterMindScript() {
smm_load_state = 1;
debug_game_state = 60;
var globalProgress = getGlobalProgress(0, 2);
console.log("current progress: " + Math.max(globalProgress, lastGlobalProgress) + "% (g)"); lastGlobalProgress = globalProgress; // !WARNING! -> this console text will be read by the android app so shall not be modified
$.ajax({
url: 'SuperMasterMind.js.gz', // SuperMasterMind.js compressed with gzip
method: "GET",
dataType: 'binary',
timeout: 300000, // 5 minutes (high timeout value to attempt to avoid the error "GAME UNHANDLEDREJECTION ERROR / reason: SyntaxError: The string did not match the expected pattern." in some browsers without/before fail() function being entered - Note: timeout = 0 does not solve it)
xhr: function() {
debug_game_state = 60.5;
xhr_smm.responseType = 'arraybuffer';
try {
// Download progress
xhr_smm.addEventListener("progress", loadSuperMasterMindScript_progressFunction, false);
}
catch (exc) {
debug_game_state = 60.6;
}
return xhr_smm;
},
success: function(data) {
smm_load_state = 2;
debug_game_state = 67;
xhr_smm.removeEventListener("progress", loadSuperMasterMindScript_progressFunction, false); // same arguments as above xhr_smm.addEventListener() call
console.log("(on scripts load)"); // !WARNING! -> this console text will be read by the android app so shall not be modified
// Unzip .js.gz file
var inflated = pako.inflate(new Uint8Array(data));
var script = document.createElement('script');
script.textContent = new TextDecoder().decode(inflated);
script.async = true;
script.onerror = function(event, source, lineno, colno, error) {
let script_load_err_str = 'Error while loading SuperMasterMind script: '
+ 'event type:' + event.type
+ '|source:' + '(smm)' + source
+ '|line number:' + lineno
+ '|column number:' + colno
+ '|error:' + error;
throw new Error(script_load_err_str);
};
debug_game_state = 67.5;
var result = document.body.appendChild(script); // execute SuperMasterMind script
if (result !== script) {
throw new Error("appendChild failed for SuperMasterMind script");
}
var globalProgress = getGlobalProgress(0.999, 2);
console.log("current progress: " + Math.max(globalProgress, lastGlobalProgress) + "% (g)"); lastGlobalProgress = globalProgress; // !WARNING! -> this console text will be read by the android app so shall not be modified
smm_load_state = 2.5;
// debug_game_state = 68 to debug_game_state = 69.x is updated in SuperMasterMind script
},
error: function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
smm_load_state = 3;
debug_game_state = 65;
var errorStr = ("SuperMasterMind script load failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
console.log(errorStr);
alert("Oops... a network error occurred!\nPlease retry...\n\n" + "(" + errorStr + ")");
smm_load_state = 3.5;
debug_game_state = 66;
}
})
.always(function() {
$(".game_loading").fadeOut("slow"); // game_loading div fades out
// $("#my_all_scripts_loaded_form").submit(); // (dummy form submission for android app's web view)
});
smm_load_state = 1.5;
}

var globalProgressForHTMLGame3 = getGlobalProgress(0.999 /* (rough value) */, 0);
console.log("current progress: " + Math.max(globalProgressForHTMLGame3, lastGlobalProgress) + "% (g)"); lastGlobalProgress = globalProgressForHTMLGame3; // !WARNING! -> this console text will be read by the android app so shall not be modified
if (globalProgressForHTMLGame3 > 0) {
$("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgressForHTMLGame3 + "%)"); // (not rem unit as no viewport! / duplicated code)
}

const loadGameSolverScript_progressFunction = function(evt) {
debug_game_state = 73;
// if (evt.lengthComputable) { -> works in Firefox but always false in Chrome when the HTML page is distant
if (evt.loaded > 0) {
var ratioComplete;
var ratioDebugStr;
if (evt.lengthComputable && (evt.total > 0)) {
ratioComplete = evt.loaded / evt.total;
ratioDebugStr = "";
}
else {
ratioComplete = Math.min(1.0, evt.loaded / loaded_sizes[1]); // (simplification useful for Chrome when the HTML page is distant)
ratioDebugStr = " (s)";
}
var globalProgress = getGlobalProgress(ratioComplete, 1);
console.log("current progress: " + Math.max(globalProgress, lastGlobalProgress) + "%" + ratioDebugStr); lastGlobalProgress = globalProgress; // !WARNING! -> this console text will be read by the android app so shall not be modified
if (globalProgress > 0) {
$("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgress + "%)"); // (not rem unit as no viewport! / duplicated code)
}
}
else {
console.log("progress: " + evt.lengthComputable + ", " + evt.loaded + ", " + evt.total);
}
debug_game_state = 74;
}

debug_game_state = 70;
gamesolver_load_state = 1;
gamesolver_load_start_time = (new Date()).getTime();
var xhr_gs = new XMLHttpRequest();
$.ajax({
url: "GameSolver.js",
method: "GET",
dataType: 'text',
mimeType: 'text/plain',
timeout: 300000, // 5 minutes (high timeout value to attempt to avoid the error "GAME UNHANDLEDREJECTION ERROR / reason: SyntaxError: The string did not match the expected pattern." in some browsers without/before fail() function being entered - Note: timeout = 0 does not solve it)
xhr: function() {
debug_game_state = 70.5;
try {
// Download progress
xhr_gs.addEventListener("progress", loadGameSolverScript_progressFunction, false);
debug_game_state = 70.55;
}
catch (exc) {
debug_game_state = 70.6;
}
return xhr_gs;
}
})
.done(function(data) { // Success case
gamesolver_load_state = 2;
debug_game_state = 75;
xhr_gs.removeEventListener("progress", loadGameSolverScript_progressFunction, false); // same arguments as above xhr_gs.addEventListener() call
// console.log(data); // data contains GameSolver script contents
if (data.indexOf("nicorn") != -1) {
github_unicorn_error = true;
}
if ( (data.indexOf("<html") != -1) || (data.indexOf("<HTML") != -1) || (data.indexOf("<body") != -1) || (data.indexOf("<BODY") != -1) ) {
github_html_error = true;
}
if ( (data.indexOf("too long to load") != -1) || (data.indexOf("did not respond") != -1)
|| (data.indexOf("o server is currently available") != -1) /* 'o' for 'no' */
|| (data.indexOf("emporarily Offline") != -1)  || (data.indexOf("emporarily offline") != -1) ) {
github_load_error = true;
}

// Blob for GameSolver script including common definitions
debug_game_state = 75.2;
gamesolver_blob = new Blob([data], {type: "application/javascript"});
if (gamesolver_blob.size <= 130000) { // 137120 in 09/2023 - approximate check for better compatibility
// Oops alert for network error could also be shown here, if ever this code is entered, as done below
throw new Error("blob creation failed for GameSolver script (" + gamesolver_blob.size + ")");
}

// Blob for common definitions only (only useful at this stage)
debug_game_state = 75.3;
var end_of_common_defitions_tag = "let END_OF_COMMON_DEFINITIONS;";
var end_of_common_defitions_index = data.indexOf(end_of_common_defitions_tag);
if (end_of_common_defitions_index == -1)  {
// Oops alert for network error could also be shown here, if ever this code is entered, as done below
throw new Error("cannot find end of common definitions in GameSolver script (" + gamesolver_blob.size + ")");
}
var common_definitions_blob = new Blob([data.substring(0, end_of_common_defitions_index + end_of_common_defitions_tag.length)], {type: "application/javascript"});
if (common_definitions_blob.size <= 17000) { // 17469 in 09/2023 - approximate check for better compatibility
// Oops alert for network error could also be shown here, if ever this code is entered, as done below
throw new Error("blob creation failed for common definitions (" + common_definitions_blob.size + ")");
}

debug_game_state = 75.4;
var url = URL.createObjectURL(common_definitions_blob);
var script = document.createElement('script');
script.src = url;
script.async = false;
script.onload = function() {
// Super Master Mind script is only loaded once GameSolver script has been loaded successfully
setTimeout("loadSuperMasterMindScript();", 44);
gamesolver_load_state = 2.55;
debug_game_state = 78;
};
script.onerror = function(event, source, lineno, colno, error) {
let script_load_err_str = 'Error while loading GameSolver script: '
+ 'event type:' + event.type
+ '|source:' + '(gs-' + common_definitions_blob.size + ')' + source
+ '|line number:' + lineno
+ '|column number:' + colno
+ '|error:' + error;
throw new Error(script_load_err_str);
};
debug_game_state = 75.6;
var result = document.body.appendChild(script);
if (result !== script) {
throw new Error("appendChild failed for GameSolver script (" + common_definitions_blob.size + ")");
}
gamesolver_load_state = 2.5;
// debug_game_state = 76 to debug_game_state = 77.x is updated in GameSolver script
})
.fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
gamesolver_load_state = 3;
debug_game_state = 79;
var errorStr = ("GameSolver script load failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
console.log(errorStr);
gamesolver_blob_error = errorStr;
alert("Oops... a network error occurred!\nPlease retry...\n\n" + "(" + errorStr + ")");
$(".game_loading").fadeOut("slow"); // game_loading div fades out
gamesolver_load_state = 3.5;
debug_game_state = 79.5;
});
gamesolver_load_state = 1.5;
</script>

</body>

</html>